<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>BeagleBone Black ä»é›¶åˆ°ä¸€ (3 Linux é•œåƒã€initramfsã€Device TreeåŠæ ¹æ–‡ä»¶ç³»ç»Ÿ) | TinyX</title>
<meta name="keywords" content="BeagleBone, Linux">
<meta name="description" content="åŸºäº Linux 3.8
å†…æ ¸å¯åŠ¨ BeagleBone Black ä»é›¶åˆ°ä¸€ (1 MLOã€U-Boot) è¿™ç¯‡æ–‡ç« é‡Œè®²åˆ° U-Boot å¯åŠ¨ä¹‹åä¼šè¿è¡Œ uEnv.txt æ–‡ä»¶é‡Œé¢ uenvcmd æŒ‡ä»£çš„å‘½ä»¤ï¼Œæˆ‘ä»¬ä¹Ÿé€šå¸¸æŠŠåŠ è½½é•œåƒæ–‡ä»¶ç­‰å‘½ä»¤å†™åœ¨è¿™é‡Œã€‚
U-Boot æœ‰å¾ˆå¤šæ–¹æ³•èƒ½å¯åŠ¨å†…æ ¸ï¼Œé€šå¸¸ä½¿ç”¨çš„æ˜¯ bootm æˆ–è€… bootz å‘½ä»¤ï¼š
U-Boot# help bootz bootz - boot Linux zImage image from memory  Usage: bootz [addr [initrd[:size]] [fdt]]  - boot Linux zImage stored in memory  The argument &#39;initrd&#39; is optional and specifies the address  of the initrd in memory. The optional argument &#39;:size&#39; allows  specifying the size of RAW initrd.">
<meta name="author" content="X">
<link rel="canonical" href="https://jesseguox.github.io/tinyx/post/BBB-Prepare-booting/">
<link crossorigin="anonymous" href="/tinyx/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css" integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/tinyx/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://jesseguox.github.io/tinyx/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="https://jesseguox.github.io/tinyx/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://jesseguox.github.io/tinyx/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://jesseguox.github.io/tinyx/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://jesseguox.github.io/tinyx/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="BeagleBone Black ä»é›¶åˆ°ä¸€ (3 Linux é•œåƒã€initramfsã€Device TreeåŠæ ¹æ–‡ä»¶ç³»ç»Ÿ)" />
<meta property="og:description" content="åŸºäº Linux 3.8
å†…æ ¸å¯åŠ¨ BeagleBone Black ä»é›¶åˆ°ä¸€ (1 MLOã€U-Boot) è¿™ç¯‡æ–‡ç« é‡Œè®²åˆ° U-Boot å¯åŠ¨ä¹‹åä¼šè¿è¡Œ uEnv.txt æ–‡ä»¶é‡Œé¢ uenvcmd æŒ‡ä»£çš„å‘½ä»¤ï¼Œæˆ‘ä»¬ä¹Ÿé€šå¸¸æŠŠåŠ è½½é•œåƒæ–‡ä»¶ç­‰å‘½ä»¤å†™åœ¨è¿™é‡Œã€‚
U-Boot æœ‰å¾ˆå¤šæ–¹æ³•èƒ½å¯åŠ¨å†…æ ¸ï¼Œé€šå¸¸ä½¿ç”¨çš„æ˜¯ bootm æˆ–è€… bootz å‘½ä»¤ï¼š
U-Boot# help bootz bootz - boot Linux zImage image from memory  Usage: bootz [addr [initrd[:size]] [fdt]]  - boot Linux zImage stored in memory  The argument &#39;initrd&#39; is optional and specifies the address  of the initrd in memory. The optional argument &#39;:size&#39; allows  specifying the size of RAW initrd." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jesseguox.github.io/tinyx/post/BBB-Prepare-booting/" /><meta property="og:image" content="https://jesseguox.github.io/tinyx/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2016-04-17T15:06:55&#43;00:00" />
<meta property="article:modified_time" content="2016-04-17T15:06:55&#43;00:00" /><meta property="og:site_name" content="ExampleSite" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://jesseguox.github.io/tinyx/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"/>

<meta name="twitter:title" content="BeagleBone Black ä»é›¶åˆ°ä¸€ (3 Linux é•œåƒã€initramfsã€Device TreeåŠæ ¹æ–‡ä»¶ç³»ç»Ÿ)"/>
<meta name="twitter:description" content="åŸºäº Linux 3.8
å†…æ ¸å¯åŠ¨ BeagleBone Black ä»é›¶åˆ°ä¸€ (1 MLOã€U-Boot) è¿™ç¯‡æ–‡ç« é‡Œè®²åˆ° U-Boot å¯åŠ¨ä¹‹åä¼šè¿è¡Œ uEnv.txt æ–‡ä»¶é‡Œé¢ uenvcmd æŒ‡ä»£çš„å‘½ä»¤ï¼Œæˆ‘ä»¬ä¹Ÿé€šå¸¸æŠŠåŠ è½½é•œåƒæ–‡ä»¶ç­‰å‘½ä»¤å†™åœ¨è¿™é‡Œã€‚
U-Boot æœ‰å¾ˆå¤šæ–¹æ³•èƒ½å¯åŠ¨å†…æ ¸ï¼Œé€šå¸¸ä½¿ç”¨çš„æ˜¯ bootm æˆ–è€… bootz å‘½ä»¤ï¼š
U-Boot# help bootz bootz - boot Linux zImage image from memory  Usage: bootz [addr [initrd[:size]] [fdt]]  - boot Linux zImage stored in memory  The argument &#39;initrd&#39; is optional and specifies the address  of the initrd in memory. The optional argument &#39;:size&#39; allows  specifying the size of RAW initrd."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://jesseguox.github.io/tinyx/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "BeagleBone Black ä»é›¶åˆ°ä¸€ (3 Linux é•œåƒã€initramfsã€Device TreeåŠæ ¹æ–‡ä»¶ç³»ç»Ÿ)",
      "item": "https://jesseguox.github.io/tinyx/post/BBB-Prepare-booting/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "BeagleBone Black ä»é›¶åˆ°ä¸€ (3 Linux é•œåƒã€initramfsã€Device TreeåŠæ ¹æ–‡ä»¶ç³»ç»Ÿ)",
  "name": "BeagleBone Black ä»é›¶åˆ°ä¸€ (3 Linux é•œåƒã€initramfsã€Device TreeåŠæ ¹æ–‡ä»¶ç³»ç»Ÿ)",
  "description": "åŸºäº Linux 3.8\nå†…æ ¸å¯åŠ¨ BeagleBone Black ä»é›¶åˆ°ä¸€ (1 MLOã€U-Boot) è¿™ç¯‡æ–‡ç« é‡Œè®²åˆ° U-Boot å¯åŠ¨ä¹‹åä¼šè¿è¡Œ uEnv.txt æ–‡ä»¶é‡Œé¢ uenvcmd æŒ‡ä»£çš„å‘½ä»¤ï¼Œæˆ‘ä»¬ä¹Ÿé€šå¸¸æŠŠåŠ è½½é•œåƒæ–‡ä»¶ç­‰å‘½ä»¤å†™åœ¨è¿™é‡Œã€‚\nU-Boot æœ‰å¾ˆå¤šæ–¹æ³•èƒ½å¯åŠ¨å†…æ ¸ï¼Œé€šå¸¸ä½¿ç”¨çš„æ˜¯ bootm æˆ–è€… bootz å‘½ä»¤ï¼š\nU-Boot# help bootz bootz - boot Linux zImage image from memory  Usage: bootz [addr [initrd[:size]] [fdt]]  - boot Linux zImage stored in memory  The argument \u0026#39;initrd\u0026#39; is optional and specifies the address  of the initrd in memory. The optional argument \u0026#39;:size\u0026#39; allows  specifying the size of RAW initrd.",
  "keywords": [
    "BeagleBone", "Linux"
  ],
  "articleBody": "åŸºäº Linux 3.8\nå†…æ ¸å¯åŠ¨ BeagleBone Black ä»é›¶åˆ°ä¸€ (1 MLOã€U-Boot) è¿™ç¯‡æ–‡ç« é‡Œè®²åˆ° U-Boot å¯åŠ¨ä¹‹åä¼šè¿è¡Œ uEnv.txt æ–‡ä»¶é‡Œé¢ uenvcmd æŒ‡ä»£çš„å‘½ä»¤ï¼Œæˆ‘ä»¬ä¹Ÿé€šå¸¸æŠŠåŠ è½½é•œåƒæ–‡ä»¶ç­‰å‘½ä»¤å†™åœ¨è¿™é‡Œã€‚\nU-Boot æœ‰å¾ˆå¤šæ–¹æ³•èƒ½å¯åŠ¨å†…æ ¸ï¼Œé€šå¸¸ä½¿ç”¨çš„æ˜¯ bootm æˆ–è€… bootz å‘½ä»¤ï¼š\nU-Boot# help bootz bootz - boot Linux zImage image from memory  Usage: bootz [addr [initrd[:size]] [fdt]]  - boot Linux zImage stored in memory  The argument 'initrd' is optional and specifies the address  of the initrd in memory. The optional argument ':size' allows  specifying the size of RAW initrd.  When booting a Linux kernel which requires a flat device-tree  a third argument is required which is the address of the  device-tree blob. To boot that kernel without an initrd image,  use a '-' for the second argument. If you do not pass a third  a bd_info struct will be passed instead  U-Boot# help bootm bootm - boot application image from memory  Usage: bootm [addr [arg ...]]  - boot application image stored in memory  passing arguments 'arg ...'; when booting a Linux kernel,  'arg' can be the address of an initrd image  When booting a Linux kernel which requires a flat device-tree  a third argument is required which is the address of the  device-tree blob. To boot that kernel without an initrd image,  use a '-' for the second argument. If you do not pass a third  a bd_info struct will be passed instead  For the new multi component uImage format (FIT) addresses  must be extened to include component or configuration unit name:  addr: - direct component image specification  addr# - configuration specification  Use iminfo command to get the list of existing component  images and configurations.  Sub-commands to do part of the bootm sequence. The sub-commands must be issued in the order below (it's ok to not issue all sub-commands):  start [addr [arg ...]]  loados - load OS image  ramdisk - relocate initrd, set env initrd_start/initrd_end  fdt - relocate flat device tree  cmdline - OS specific command line processing/setup  bdt - OS specific bd_t processing  prep - OS specific prep before relocation or go  go - start OS bootz å¯åŠ¨å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ zImage ï¼Œæ”¯æŒ device-treeï¼Œå…¶ä¸­ä¸€äº›å‚æ•°ï¼š addrï¼šå†…æ ¸åœ°å€ initrdï¼šramdisk é•œåƒåœ°å€ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šçš„ initrd éœ€è¦ä¼ é€’ä¸€ä¸ª - ç»™å¯åŠ¨æŒ‡ä»¤ã€‚ä»€ä¹ˆæ˜¯ ramdisk é•œåƒå‘¢ï¼Ÿæˆ‘ä»¬ä¸‹é¢ä¼šè®²åˆ°ã€‚ fdtï¼š flat device tree åœ°å€ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š fdt åœ°å€ï¼Œä¼šä¼ å…¥ä¸€ä¸ª bd_info ç»“æ„ä½“ã€‚ä»€ä¹ˆæ˜¯ Device Tree å‘¢ï¼Ÿæˆ‘ä»¬ä¸‹é¢ä¹Ÿä¼šè®²åˆ°ã€‚\nLinux å¯åŠ¨éœ€è¦çš„æ–‡ä»¶ Linux å¯åŠ¨çš„æ—¶å€™éœ€è¦æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿæ¥è¿è¡Œåˆå§‹åŒ–ç¨‹åºï¼Œå†æ€»ç»“ bootz å‘½ä»¤ï¼Œæ‰€ä»¥ U-Boot å¯åŠ¨ Linux å†…æ ¸éœ€è¦ä»¥ä¸‹æ–‡ä»¶ï¼š å†…æ ¸é•œåƒã€initrd æ–‡ä»¶ï¼ˆramdisk é•œåƒï¼‰ã€DTBï¼ˆDevice Tree Binaryï¼‰ã€æ ¹æ–‡ä»¶ç³»ç»Ÿ ä¸æ˜¯å¿…è¦ä½†æ˜¯ä¹Ÿæ˜¯éœ€è¦çš„æ–‡ä»¶ï¼š System.map\nLinux å†…æ ¸é•œåƒ vm ä»£è¡¨ Virtual Memoryï¼ŒLinux æ”¯æŒè™šæ‹Ÿå†…å­˜ï¼Œå› æ­¤å¾—å vmã€‚Linux å†…æ ¸æŒ‰å¼•å¯¼ç¨‹åºçš„ä¸åŒåˆ†ä¸åŒçš„æ ¼å¼ï¼Œä¸»è¦æœ‰ï¼š\n vmlinux\t: æœ€åŸå§‹çš„å†…æ ¸é™æ€é“¾æ¥åå¯æ‰§è¡Œçš„æ–‡ä»¶æ ¼å¼ ELFï¼Œæ²¡æœ‰å‹ç¼©ï¼Œä¸å¯å¯åŠ¨çš„å†…æ ¸é•œåƒï¼Œå¯èƒ½åœ¨è°ƒè¯•é˜¶æ®µæ‰ä¼šç”¨åˆ°ã€‚ vmlinux.bin : å’Œ vmlinux ç±»ä¼¼ä¸è¿‡æ˜¯å¯å¯åŠ¨çš„ RAW Binary æ ¼å¼ã€‚æ‰€æœ‰çš„æ ‡å¿—å’Œé‡å®šä½ä¿¡æ¯éƒ½è¢«ä¸¢å¼ƒï¼Œç”± vmlinux é€šè¿‡å‘½ä»¤ objcopy -O binary vmlinux vmlinux.bin ç”Ÿæˆã€‚ vmlinuz\t: ç»è¿‡å‹ç¼©è¿‡çš„ vmlinux å¯å¯åŠ¨é•œåƒã€‚å¯å¯åŠ¨è¡¨ç¤ºæœ‰èƒ½åŠ›åŠ è½½æ“ä½œç³»ç»Ÿåˆ°å†…å­˜ä¸­è¿è¡Œï¼Œvmlinuz é€šå¸¸ç”± zImage å’Œ bzImage æ‹·è´è€Œæ¥ã€‚ zImage\t: æ¯”zImage æ˜¯ ARM linux å¸¸ç”¨çš„ä¸€ç§å‹ç¼©é•œåƒæ–‡ä»¶ï¼Œå®ƒæ˜¯ç”± vmlinux åŠ ä¸Šè§£å‹ä»£ç ç» gzip å‹ç¼©è€Œæˆï¼Œé€šå¸¸æ”¾åœ¨å°å°ºå¯¸ ROM ä¸­ï¼ˆå°äº 512Kï¼‰ï¼ŒzImage è§£å‹ç¼©å†…æ ¸åˆ°ä½å®¹é‡å†…å­˜(640K)ã€‚ç”±å‘½ä»¤ make zImage ç”Ÿæˆã€‚ bzImage\t: bz è¡¨ç¤º big zImage,å…¶æ ¼å¼ä¸ zImage ç±»ä¼¼ï¼Œä½†é‡‡ç”¨äº†ä¸åŒçš„å‹ç¼©ç®—æ³•ã€‚bzImage éœ€è¦è§£å‹ç¼©å†…æ ¸åˆ°é«˜å®¹é‡å†…å­˜(1Mä»¥ä¸Š)ã€‚ç”±å‘½ä»¤ make bzImage ç”Ÿæˆã€‚ uImage\t: uImage æ˜¯ uboot ä¸“ç”¨çš„é•œåƒæ–‡ä»¶ï¼Œå®ƒæ˜¯åœ¨ zImage ä¹‹å‰åŠ ä¸Šä¸€ä¸ªé•¿åº¦ä¸º 0x40 çš„å¤´ä¿¡æ¯(tag)ï¼Œåœ¨å¤´ä¿¡æ¯å†…è¯´æ˜äº†è¯¥é•œåƒæ–‡ä»¶çš„ç±»å‹ã€åŠ è½½ ä½ç½®ã€ç”Ÿæˆæ—¶é—´ã€å¤§å°ç­‰ä¿¡æ¯ã€‚å…¶ 0x40 ä¹‹åä¸ zImage æ²¡åŒºåˆ«ã€‚  ç¼–è¯‘åŠç”Ÿæˆï¼š BeagleBone çš„å†…æ ¸é•œåƒæ‰˜ç®¡åœ¨ Github ç¼–è¯‘ä¹‹å‰å¯èƒ½éœ€è¦å®‰è£…çš„åº“\nâœ sudo apt-get install lzop âœ sudo apt-get install libncurses5-dev libncursesw5-dev æºç é‡Œé¢å·²ç»åŒ…å«äº† BeagleBone çš„é…ç½®æ–‡ä»¶ï¼š\nâœ git clone git://github.com/beagleboard/linux.git âœ cd linux âœ git checkout 3.8 âœ make distclean âœ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- bb.org_defconfig âœ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage dtbs -j4 ç¼–è¯‘å®Œæˆåä¼šåœ¨ arch/arm/boot ç›®å½•ä¸‹é¢ç”Ÿæˆ zImage é•œåƒå’Œ dtbs æ–‡ä»¶ã€‚ æˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- menuconfig æˆ–è€… make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- xconfig æ¥è‡ªå·±é…ç½®éœ€è¦ç¼–è¯‘çš„å†…å®¹ã€‚ å¦‚æœä½¿ç”¨ make xconfig åˆ™éœ€è¦å®‰è£… qt å’Œä¸€äº›ä¾èµ–ï¼Œå¦‚æœä½¿ç”¨è™šæ‹Ÿæœºä¸èƒ½ä½¿ç”¨ ssh çš„æ–¹å¼è¿œç¨‹ç¼–è¯‘ï¼Œéœ€è¦æ‰“å¼€è™šæ‹Ÿçš„å›¾å½¢ç•Œé¢è¿›è¡Œç¼–è¯‘ã€‚ xconfig çš„ä¸€äº›ä¾èµ–ï¼š\nâœ sudo apt-get update âœ sudo apt-get install libqt4-dev pkg-config âœ sudo apt-get install g++ initrdã€initramfs Linux kernel åœ¨è‡ªèº«åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œéœ€è¦èƒ½å¤Ÿæ‰¾åˆ°å¹¶è¿è¡Œç¬¬ä¸€ä¸ªç”¨æˆ·ç¨‹åºï¼ˆè¿™ä¸ªç¨‹åºé€šå¸¸å«åš â€œinitâ€ ç¨‹åºï¼‰ã€‚ç”¨æˆ·ç¨‹åºå­˜åœ¨äºæ–‡ä»¶ç³»ç»Ÿä¹‹ä¸­ï¼Œå› æ­¤ï¼Œå†…æ ¸å¿…é¡»æ‰¾åˆ°å¹¶æŒ‚è½½ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ‰å¯ä»¥æˆåŠŸå®Œæˆç³»ç»Ÿçš„å¼•å¯¼è¿‡ç¨‹ã€‚\u0008æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆrootfsï¼‰ æ‰€åœ¨çš„å‚¨å­˜è£…ç½®å¾ˆå¯èƒ½æéš¾å¯»æ‰¾ï¼Œæ¯”æ–¹è¯´ SCSI è£…ç½®å°±éœ€è¦å¤æ‚ä¸”è€—æ—¶çš„ç¨‹åºï¼Œè‹¥ç”¨ RAID ç³»ç»Ÿæ›´æ˜¯éœ€è¦çœ‹é…ç½®æƒ…å†µè€Œå®šï¼ŒåŒæ ·çš„é—®é¢˜ä¹Ÿå‘ç”Ÿåœ¨ USB storage ä¸Šï¼Œå› ä¸º kernel å¾—èŠ±ä¸Šæ›´é•¿çš„ç­‰å¾…ä¸é…ç½®æ—¶é—´ï¼Œåˆæˆ–è€…éœ€è¦è¿œç«¯æŒ‚è½½ rootfsï¼Œä¸ä»…å¾—å¤„ç†ç½‘è·¯è£…ç½®çš„é—®é¢˜ï¼Œç”šè‡³è¿˜å¾—è€ƒè™‘ç›¸å…³çš„ä¼ºæœå™¨è®¤è¯ã€é€šè®¯å¾€è¿”æ—¶é—´ç­‰è®®é¢˜ã€‚ä¸ºè§£å†³æ­¤é—®é¢˜ï¼ŒLinux kernel æå‡ºäº†ä¸€ä¸ª RAM disk çš„è§£å†³æ–¹æ¡ˆï¼ŒæŠŠä¸€äº›å¯åŠ¨æ‰€å¿…é¡»çš„ç”¨æˆ·ç¨‹åºå’Œé©±åŠ¨æ¨¡å—æ”¾åœ¨ RAM disk ä¸­ï¼Œè¿™ä¸ª RAM disk çœ‹ä¸Šå»å’Œæ™®é€šçš„ disk ä¸€æ ·ï¼Œæœ‰æ–‡ä»¶ç³»ç»Ÿï¼Œæœ‰ cacheï¼Œå†…æ ¸å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæŠŠ RAM disk æŒ‚è½½èµ·æ¥ï¼Œç­‰åˆ° init ç¨‹åºå’Œä¸€äº›å¿…è¦æ¨¡å—è¿è¡Œèµ·æ¥ä¹‹åï¼Œå†åˆ‡åˆ°çœŸæ­£çš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸­ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæœ‰äº† initrdï¼ˆinit ram diskï¼‰ æˆ‘ä»¬å¯åœ¨æ”¾ç½®æŸäº›ç‰¹åˆ«çš„ç¨‹å¼ï¼Œä¸€æ¥ä½œä¸ºæŒ‚è½½ rootfs ä½œå‡†å¤‡ï¼Œæ¯”æ–¹è¯´ç¡¬ä½“åˆå§‹åŒ–ã€è§£å¯†ã€è§£å‹ç¼©ç­‰ç­‰ï¼ŒäºŒæ¥æç¤ºä½¿ç”¨è€…æˆ–ç³»ç»Ÿç®¡ç†å‘˜ç›®å‰çš„çŠ¶æ€ï¼Œè¿™å¯¹äºæ¶ˆè´¹æ€§ç”µå­äº§å“æ¥è¯´ï¼Œæœ‰å¾ˆå¤§çš„æ„ä¹‰ã€‚ æ•´ä½“æ¥è¯´ï¼Œå¦‚æœèƒ½å¢åŠ å¼€æœºçš„å¼¹æ€§ï¼ˆæ¯”æ–¹è¯´é…åˆç®€å•çš„shell script å³â€‹â€‹å¯è¾¾æˆUSB/SCSI åˆå§‹åŒ–åŠ¨ä½œï¼Œè‹¥é€è¿‡ kernel code å®åšï¼Œææ€•ä¸Šç™¾åƒè¡Œæ˜¯å…ä¸æ‰çš„ï¼‰ï¼Œåˆèƒ½é€‚åº¦é™ä½ kernel image æœ¬èº«çš„è®¾è®¡å¤æ‚åº¦ä¸ç©ºé—´ä½¿ç”¨é‡ï¼Œé‡‡å– initrd æ˜¯å¾ˆä¸é”™çš„æ–¹å¼ï¼Œæ‰€ä»¥å‡ ä¹å„å¤§Linux distribution éƒ½æœ‰æä¾› initrdï¼Œä»¥è§£å†³åœ¨ä¸åŒç¡¬ä½“ã€ä¸åŒè£…ç½®ä¸Šå¼€æœºçš„æŠ€æœ¯è®®é¢˜ã€‚ å¦‚æœä»”ç»†è€ƒè™‘ä¸€ä¸‹ï¼Œinitrd è™½ç„¶è§£å†³äº†é—®é¢˜ä½†å¹¶ä¸å®Œç¾ã€‚ æ¯”å¦‚ï¼Œdisk æœ‰ cache æœºåˆ¶ï¼Œå¯¹äº RAM disk æ¥è¯´ï¼Œè¿™ä¸ª cache æœºåˆ¶å°±æ˜¾å¾—å¾ˆå¤šä½™ä¸”æµªè´¹ç©ºé—´ï¼›disk éœ€è¦æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ ext2 ç­‰ï¼‰å¿…é¡»è¢«ç¼–è¯‘è¿› kernel è€Œä¸èƒ½ä½œä¸ºæ¨¡å—æ¥ä½¿ç”¨ã€‚ Linux 2.6 kernel æå‡ºäº†ä¸€ç§æ–°çš„å®ç°æœºåˆ¶ï¼Œå³ initramfsã€‚é¡¾åæ€ä¹‰ï¼Œinitramfs åªæ˜¯ä¸€ç§ RAM filesystem è€Œä¸æ˜¯ diskã€‚initramfs å®é™…æ˜¯ä¸€ä¸ª cpio å½’æ¡£ï¼Œå¯åŠ¨æ‰€éœ€çš„ç”¨æˆ·ç¨‹åºå’Œé©±åŠ¨æ¨¡å—è¢«å½’æ¡£æˆä¸€ä¸ªæ–‡ä»¶ã€‚å› æ­¤ï¼Œä¸éœ€è¦ cacheï¼Œä¹Ÿä¸éœ€è¦æ–‡ä»¶ç³»ç»Ÿã€‚\nå¼•ç”¨ï¼šå…³äº initramfs \n The only purpose of an initramfs is to mount the root filesystem. The initramfs is a complete set of directories that you would find on a normal root filesystem. It is bundled into a single cpio archive and compressed with one of several compression algorithms. initramfs çš„å”¯ä¸€ç”¨é€”å°±æ˜¯æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚initramfs å°±æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ç³»ç»Ÿç›®å½•çš„å®Œæ•´çš„é›†åˆã€‚å®ƒç”¨å‡ ä¸ªå‹ç¼©ç®—æ³•æ‰“åŒ…æˆ cpio æ ¼å¼ã€‚ There are only four primary reasons to have an initramfs in the LFS environment: loading the rootfs from a network, loading it from an LVM logical volume, having an encrypted rootfs where a password is required, or for the convenience of specifying the rootfs as a LABEL or UUID. Anything else usually means that the kernel was not configured properly. åœ¨ LFS (Linux From Scratch) ä¸­ initramfs çš„å­˜åœ¨ä¸»è¦æœ‰å››ä¸ªä¸»è¦çš„åŸå› ï¼šä»ç½‘ç»œåŠ è½½æ ¹æ–‡ä»¶ç³»ç»Ÿã€ä» LMM é€»è¾‘å·åŠ è½½çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€åŠ å¯†è¿‡çš„éœ€è¦å¯†ç çš„æ ¹æ–‡ä»¶ç³»ç»Ÿæˆ–è€…æ–¹ä¾¿çš„æŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿä¸º LABLE æˆ–è€… UUIDã€‚è¿˜æœ‰åˆ«çš„é€šå¸¸æ„å‘³ç€å†…æ ¸é…ç½®ä¸æ­£ç¡®ã€‚ For most distributions, kernel modules are the biggest reason to have an initramfs. In a general distribution, there are many unknowns such as file system types and disk layouts. In a way, this is the opposite of LFS where the system capabilities and layout are known and a custom kernel is normally built. In this situation, an initramfs is rarely needed. å¯¹äºå¤§å¤šæ•°åˆ†å‘ç‰ˆæœ¬æ¥è¯´ï¼Œéœ€è¦ initramfs æœ€å¤§çš„åŸå› æ˜¯å†…æ ¸æ¨¡å—ã€‚åœ¨ä¸€èˆ¬çš„åˆ†å‘ä¸­ï¼Œæœ‰å¾ˆå¤šæœªçŸ¥çš„æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜åˆ†å¸ƒï¼Œåœ¨æŸç§ç¨‹åº¦ä¸‹ï¼Œè¿™æ˜¯åœ¨ç³»ç»Ÿèƒ½åŠ›å’Œå¸ƒå±€æœªçŸ¥çš„æƒ…å†µã€‚ å¦‚æœè¯´ç³»ç»Ÿèƒ½åŠ›å’Œå¸ƒå±€å·²çŸ¥ï¼Œå†…æ ¸å·²ç»å»ºç«‹çš„æƒ…å†µä¸‹å¾ˆå°‘éœ€è¦ initramfsã€‚\n ä¸Šé¢æåˆ°çš„ RAM DISK ä¸º image-initrdï¼ŒRAM filesystem ä¸º cpio-initrdï¼Œå†…æ ¸å¯åŠ¨çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­æ˜¯å¦ä¸º cpio æ ¼å¼ï¼Œå¦‚æœä¸æ˜¯çš„è¯ä¼šå½“ä½œ image-initrd å¤„ç†ã€‚\ncpio-initrd å’Œ image-initrd å¤„ç†æµç¨‹å¯ä»¥å‚è€ƒï¼šLinux2.6 å†…æ ¸çš„ Initrd æœºåˆ¶è§£æã€‚\nç¼–è¯‘åŠç”Ÿæˆï¼š Linux 2.6 ä»¥æ¥éƒ½æ˜¯é»˜è®¤ä½¿ç”¨ initramfsï¼ˆâ€œGeneral setupâ€ çš„å­é …ç›® â€œInitial RAM filesystem and RAM disk (initramfs/initrd) suppotâ€ æ˜¯é»˜è®¤å‹¾é€‰çš„ï¼‰ ï¼Œåªæ˜¯ç¼–è¯‘çš„è¾“å‡ºå¾ˆå¤šè¿˜æ²¿è¢­ä¼ ç»Ÿä½¿ç”¨ initrd çš„åå­—ã€‚ç¼–è¯‘çš„æ—¶å€™ä¼šç”Ÿæˆ  usr/initramfs_data.cpio æ–‡ä»¶ï¼Œå†…æ ¸ç¼–è¯‘çš„æ—¶å€™ä¼šæŠŠè¿™ä¸ªæ–‡ä»¶ç¼–è¯‘è¿›å†…æ ¸ã€‚å¦‚æœé…ç½®é€‰é¡¹é‡Œé¢ â€œInitramfs source fileâ€ ä¸ºç©ºï¼ˆä¸æŒ‡å®š CONFIG_INITRAMFS_SOURCEï¼‰ï¼Œä¼šé»˜è®¤ç¼–è¯‘å‡ºä¸€ä¸ªç©ºçš„ initramfs åŒ…ï¼ˆæ²¡æœ‰ init æ–‡ä»¶ï¼‰ã€‚ è¿™æ ·ä¸€æ¥ Linux å†…æ ¸ç¼–è¯‘çš„æ—¶å€™å¦‚æœæŒ‰é»˜è®¤æ–¹å¼ç¼–è¯‘ï¼ˆå‹¾é€‰ â€œinitial RAM filesystem and RAM disk (initramfs/initrd) suppotâ€ï¼‰ åˆ™æœ‰å››ç§æ–¹æ³•ç”Ÿæˆ initramfs æ–‡ä»¶ï¼š 1. ä¸æŒ‡å®š CONFIG_INITRAMFS_SOURCE åˆ™ä¼šç¼–è¯‘å‡ºä¸€ä¸ªç©ºçš„ initramfs 2. ä¸º CONFIG_INITRAMFS_SOURCE æŒ‡å®šä¸€ä¸ªç°æœ‰çš„ initramfs æ–‡ä»¶ å¦‚æœä½ æœ‰ä¸€ä¸ªç°æœ‰çš„ initramfs_data.cpio.gz æ–‡ä»¶ï¼Œå¯ä»¥æŒ‡å®šç»™ CONFIG_INITRAMFS_SOURCE ï¼Œå†…æ ¸ç¼–è¯‘æ—¶ä¼šè‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç±»å‹ç„¶åé“¾æ¥åˆ°å†…æ ¸é•œåƒä¸­å»ã€‚ 3. ä¸º CONFIG_INITRAMFS_SOURCE æŒ‡å®šä¸€ä¸ªç°æœ‰çš„æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½• å¦‚æœä¸º CONFIG_INITRAMFS_SOURCE æŒ‡å®šä¸€ä¸ªç›®å½•ï¼Œç¼–è¯‘çš„æ—¶å€™ä¼šè‡ªåŠ¨æŠŠæ­¤ç›®å½•æ‰“åŒ…æˆ cpio æ–‡ä»¶ï¼Œä½†æ˜¯ä¸æ˜¯ç”¨çš„æ ‡å‡†çš„ cpio å‘½ä»¤æ‰“åŒ…ï¼Œå†…æ ¸ç¼–è¯‘æ—¶ä¼šåœ¨æŒ‡å®šçš„ç›®å½•ç”Ÿæˆä¸€ä¸ªæè¿°ç›®å½•ç»“æ„çš„æ–‡æœ¬æ–‡ä»¶ gen_initramfs_list.shï¼Œç„¶åç»™ gen_init_cpio ç¨‹åºï¼ˆåœ¨ usr ç›®å½•ä¸‹ï¼‰è°ƒç”¨ï¼Œå°±ä¼šç”Ÿæˆ cpio åŒ…ã€‚ 4. ä½¿ç”¨ initramfs_list é…ç½®æ–‡ä»¶é…ç½® è¿™å°±æ˜¯åˆšåˆšç¬¬ä¸‰ç§æ–¹æ³•è®²çš„é…ç½®æ–‡ä»¶ gen_initramfs_list.shï¼Œä¸è¿‡æˆ‘ä»¬è¿™é‡Œæ˜¯æ‰‹åŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶è€Œä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆã€‚æ‰‹åŠ¨åˆ›å»ºåæ”¾å…¥ä¸€ä¸ªç›®å½•ä¸­ï¼Œç„¶åæŒ‡å®š CONFIG_INITRAMFS_SOURCE ä¸ºé‚£ä¸ªç›®å½•ç¼–è¯‘çš„æ—¶å€™å°±å¯ä»¥ç”Ÿæˆç›¸åº”çš„ cpio åŒ…ã€‚ ä¾‹å­ï¼š\nfile /init usr/hello 500 0 0 dir /dev 755 0 0 è¿™ä¸ªå†…å®¹è¡¨ç¤ºæŠŠ usr/hello æŒ‡å®šä¸ºæ–‡ä»¶ç³»ç»Ÿä¸­çš„ init æ–‡ä»¶ï¼Œæƒé™ä¸º 500ï¼Œuid å’Œ gid éƒ½ä¸º0ï¼Œå¹¶ä¸”åˆ›å»º /dev æ–‡ä»¶å¤¹ï¼Œæƒé™ä¸º 755ï¼Œuid å’Œ gid éƒ½ä¸º 0ã€‚ è¯¦ç»†ä½¿ç”¨æ–¹æ³•è¯·çœ‹ï¼šTech Tip: How to use initramfs.\nå€¼å¾—æ³¨æ„çš„æ˜¯æˆ‘ä»¬æŒ‰ç…§è¿™ä¸ªæ–¹æ³•åˆ¶ä½œå‡ºæ¥çš„å†…æ ¸é•œåƒå®é™…ä¸Šæ¯”åŸæ¥çš„å¤§äº†è®¸å¤šï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯å°† initramfs æ ¹æ–‡ä»¶ç³»ç»Ÿç›´æ¥åˆå¹¶åˆ°å†…æ ¸é•œåƒé‡Œè¾¹äº†ã€‚è¿™æ ·ï¼Œå¯åŠ¨å†…æ ¸æ—¶çš„å‚æ•°å°±ä¸éœ€è¦æ·»åŠ  initrd=â€¦â€¦ æ¥æŒ‡å®š initramfs çš„ä½ç½®äº†ï¼ˆæˆ–è€…é…ç½®å†…æ ¸çš„æ—¶å€™ç›´æ¥ä¸å‹¾é€‰ â€œInitial RAM filesystem and RAM disk (initramfs/initrd) suppotâ€ï¼Œä½†æ˜¯ä¸ºäº†å¯æ‰©å±•æ€§ä¸€èˆ¬é»˜è®¤å‹¾é€‰ï¼‰ã€‚ å¯åŠ¨å‘½ä»¤ä¸ºï¼š\nbootz ${loadaddr} - ${fdtaddr}; å½“ç„¶å¦‚æœæƒ³æŒ‡å®šå¤–éƒ¨çš„ initramfs æ–‡ä»¶æ¥å¯åŠ¨ Linuxï¼Œé¦–å…ˆç›´æ¥æŒ‡å®š CONFIG_INITRAMFS_SOURCE ä¸ºç©ºï¼Œè¿™æ ·å°±ä¼šé“¾æ¥ä¸€ä¸ªç©ºçš„ initramfs ï¼ˆä¸€ç™¾å¤šå­—èŠ‚ï¼‰è¿›å†…æ ¸ï¼Œç„¶åæŒ‡å®šå¤–éƒ¨ initramfs çš„ä½ç½®æ¥å¯åŠ¨ã€‚ å‘½ä»¤ä¸ºï¼š\nbootz ${loadaddr} ${rdaddr}:${rdsize} ${fdtaddr}; æ‰‹åŠ¨ç”Ÿæˆ initramfs æ–‡ä»¶ï¼š\nâœ mkdir sub âœ cp hello sub/init âœ cd sub âœ find . | cpio -o -H newc | gzip  ../initramfs_data.cpio.gz âœ cd .. âœ rm -rf sub System.map System.map æ˜¯ä¸€ä¸ªç‰¹å®šå†…æ ¸çš„å†…æ ¸ç¬¦å·è¡¨ã€‚å®ƒæ˜¯ä½ å½“å‰è¿è¡Œçš„å†…æ ¸çš„ç¬¦å·é“¾æ¥ã€‚Linux å†…æ ¸æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„ä»£ç å—ï¼Œæœ‰è®¸è®¸å¤šå¤šçš„å…¨å±€ç¬¦å·ã€‚å†…æ ¸å¹¶ä¸ä½¿ç”¨ç¬¦å·åã€‚å®ƒæ˜¯é€šè¿‡å˜é‡æˆ–å‡½æ•°çš„åœ°å€(æŒ‡é’ˆ)æ¥ä½¿ç”¨å˜é‡æˆ–å‡½æ•°çš„ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ size_t BytesReadï¼Œå†…æ ¸æ›´å–œæ¬¢ä½¿ç”¨(ä¾‹å¦‚) c0343f20 æ¥å¼•ç”¨è¿™ä¸ªå˜é‡ã€‚ å½“ä½ ç¼–è¯‘ä¸€ä¸ªæ–°å†…æ ¸æ—¶ï¼Œå„ä¸ªç¬¦å·åçš„åœ°å€è¦å‘ç”Ÿå˜åŒ–ï¼Œä½ çš„è€çš„ System.map å…·æœ‰çš„æ˜¯é”™è¯¯çš„ç¬¦å·ä¿¡æ¯ã€‚æ¯æ¬¡å†…æ ¸ç¼–è¯‘æ—¶äº§ç”Ÿä¸€ä¸ªæ–°çš„ System.mapï¼Œä½ åº”å½“ç”¨æ–°çš„System.map æ¥å–ä»£è€çš„ System.mapã€‚ è™½ç„¶å†…æ ¸æœ¬èº«å¹¶ä¸çœŸæ­£ä½¿ç”¨ System.mapï¼Œä½†å…¶å®ƒç¨‹åºæ¯”å¦‚ klogdï¼Œ lsof å’Œ ps ç­‰è½¯ä»¶éœ€è¦ä¸€ä¸ªæ­£ç¡®çš„ System.mapã€‚å¦‚æœä½ ä½¿ç”¨é”™è¯¯çš„æˆ–æ²¡æœ‰ System.mapï¼Œklogd çš„è¾“å‡ºå°†æ˜¯ä¸å¯é çš„ï¼Œè¿™å¯¹äºæ’é™¤ç¨‹åºæ•…éšœä¼šå¸¦æ¥å›°éš¾ã€‚æ²¡æœ‰ System.mapï¼Œä½ å¯èƒ½ä¼šé¢ä¸´ä¸€äº›ä»¤äººçƒ¦æ¼çš„æç¤ºä¿¡æ¯ã€‚ å¦å¤–å°‘æ•°é©±åŠ¨éœ€è¦ System.map æ¥è§£æç¬¦å·ï¼Œæ²¡æœ‰ä¸ºä½ å½“å‰è¿è¡Œçš„ç‰¹å®šå†…æ ¸åˆ›å»ºçš„System.map å®ƒä»¬å°±ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚ Linux çš„å†…æ ¸æ—¥å¿—å®ˆæŠ¤è¿›ç¨‹ klogd ä¸ºäº†æ‰§è¡Œåç§°-åœ°å€è§£æï¼Œklogd éœ€è¦ä½¿ç”¨System.mapã€‚System.map åº”å½“æ”¾åœ¨ä½¿ç”¨å®ƒçš„è½¯ä»¶èƒ½å¤Ÿæ‰¾åˆ°å®ƒçš„åœ°æ–¹ã€‚æ‰§è¡Œï¼šman klogd å¯çŸ¥ï¼Œå¦‚æœæ²¡æœ‰å°† System.map ä½œä¸ºä¸€ä¸ªå˜é‡çš„ä½ç½®ç»™ klogdï¼Œé‚£ä¹ˆå®ƒå°†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºï¼Œåœ¨ä¸‰ä¸ªåœ°æ–¹æŸ¥æ‰¾ System.mapï¼š /boot/System.map /System.map /usr/src/linux/System.map System.map ä¹Ÿæœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œklogd èƒ½å¤Ÿæ™ºèƒ½åœ°æŸ¥æ‰¾æ­£ç¡®çš„æ˜ è±¡ï¼ˆmapï¼‰æ–‡ä»¶ã€‚\nç¼–è¯‘åŠç”Ÿæˆï¼š System.map æ–‡ä»¶åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™ä¼šè‡ªåŠ¨ç”Ÿæˆåœ¨æºç æ ¹ç›®å½•ä¸‹ï¼Œæ¯æ¬¡é‡æ–°ç¼–è¯‘å†…æ ¸éƒ½è¦æ›¿æ¢æ‰ç›¸åº”çš„ System.mapã€‚\nDevice Tree æœºåˆ¶ Kernel 3.x ç‰ˆæœ¬ä¹‹åå¼€å§‹æ”¯æŒ Device Tree æœºåˆ¶ã€‚ åœ¨æ—©æœŸçš„ARM Linux Kernelä¸­ï¼Œæ¿çº§ç»†èŠ‚ï¼ˆBSPï¼‰ä½¿ç”¨ä»£ç å½¢å¼ï¼Œå­˜æ”¾åœ¨ arch/arm/ ç›®å½•ã€‚åå­—é€šå¸¸ä¸ºï¼šplat-xxxx æˆ–è€… mach-xxxxï¼Œç›¸å½“å¤šæ•°çš„ä»£ç åªæ˜¯åœ¨æè¿°æ¿çº§ç»†èŠ‚ï¼Œè€Œè¿™äº›æ¿çº§ç»†èŠ‚å¯¹äºå†…æ ¸æ¥è®²ï¼Œä¸è¿‡æ˜¯åƒåœ¾ã€‚æ¿çº§ä»£ç åªå¯¹ç›¸åº”å¼€å‘æ¿æœ‰ç”¨ï¼Œæ¯æ¬¡å‡çº§ Kernel éƒ½éœ€è¦å¯¹æ¿çº§ä»£ç è¿›è¡Œå‡çº§å’Œæµ‹è¯•ï¼ŒARM å¯¹åº”çš„å¼€å‘æ¿åˆç§ç±»ç¹å¤šæ‰€ä»¥è¿™äº›ä»£ç è¶Šæ¥è¶Šè‡ƒè‚¿åºå¤§ã€‚ å¼•å…¥äº† Device Tree ä¹‹åï¼Œæ”¹å˜äº†åŸæ¥ç”¨ç¡¬ç¼–ç çš„æ–¹å¼æŠŠæ¿çº§ä»£ç åµŒå…¥åœ¨å†…æ ¸é‡Œé¢ï¼Œæ”¹ç”¨é€šè¿‡ Bootloader ä¼ é€’ DB æ–‡ä»¶çš„æ–¹å¼æŠŠç¡¬ä»¶ä¿¡æ¯ä¼ é€’ç»™ Kernelï¼Œå®ç°äº†å†…æ ¸å’Œæ¿çº§ä»£ç çš„ä½è€¦åˆï¼Œå‡å°‘å†…æ ¸ä»£ç çš„è‡ƒè‚¿é™ä½ç»´æŠ¤äººå‘˜çš„æˆæœ¬ã€‚ Uboot çš„ä¸»çº¿ä»£ç ä» v1.1.3 å¼€å§‹å°±æ”¯æŒ DT äº†ï¼Œå…¶å¯¹ARMçš„æ”¯æŒå’Œ Kernel å¯¹ Device Tree çš„æ”¯æŒæ˜¯åŒæœŸå®Œæˆçš„ï¼Œåœ¨ Uboot ä¸­éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥  #define CONFIG_OF_LIBFDT é…ç½®é¡¹å³å¯ï¼Œå½“æˆ‘ä»¬å°† DTB æ–‡ä»¶åœ¨ Uboot é‡ŒåŠ è½½åˆ°å†…å­˜ä¸­åï¼Œé€šè¿‡ fdt addr 0xnnnnnnnn å‘½ä»¤æ¥è®¾ç½® DTB æ–‡ä»¶å¯¹åº”åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ fdt resizeã€fdt print ç­‰å‘½ä»¤å¯¹ DTB æ–‡ä»¶è¿›è¡Œæ“ä½œäº†ã€‚å¯¹äº ARMï¼Œä½¿ç”¨ bootz ${loadaddr} ${rdaddr}:${rdsize} ${fdtaddr} å‘½ä»¤æ¥å¯åŠ¨ Kernelã€‚ æ›´å¤šèƒŒæ™¯ä»‹ç»ï¼šDevice Tree èƒŒæ™¯ä»‹ç»\nç¼–è¯‘åŠç”Ÿæˆï¼š DTSï¼šDevice Tree Source ä½äºç›®å½• linux/arch/arm/boot/dts DTCï¼šDevice Tree Compiler ä½äºç›®å½• linux/scripts/dtc/dtc DTBï¼šDevice Tree Binary ç”Ÿæˆåœ¨ linux/arch/arm/boot/dts DTB æ˜¯ç”± DTS é€šè¿‡ DTC ç¼–è¯‘è€Œæˆã€‚ åœ¨æ„å»ºå†…æ ¸çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- dtbs ç”Ÿæˆã€‚ Device Tree Binary åœ¨ç¼–è¯‘ linux å†…æ ¸çš„æ—¶å€™è‡ªåŠ¨æ ¹æ® arch/arm/boot/dts/Makefile æŒ‡å®šçš„æ–¹å¼ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡ dtc æ‰‹åŠ¨ç¼–è¯‘ï¼š\nâœ ./scripts/dtc/dtc -I dts -O dtb -o ./devicetree.dtb ./beaglebone.dts DTS ç»„æˆå’Œç»“æ„ä¸“é—¨å†™ä¸€ç¯‡æ–‡ç« æ¥è®²ã€‚\næ ¹æ–‡ä»¶ç³»ç»Ÿ æ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯å†…æ ¸æŒ‚è½½çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæ ¹æ–‡ä»¶ç³»ç»Ÿä¸ºåˆ†å±‚æ–‡ä»¶æ ‘çš„é¡¶ç‚¹ã€‚å®ƒåŒ…å«å¯¹äºç³»ç»Ÿæ“ä½œå¾ˆå…³é”®çš„æ–‡ä»¶å’Œç›®å½•ï¼ŒåŒ…æ‹¬è®¾å¤‡ç›®å½•å’Œç”¨äºå¼•å¯¼ç³»ç»Ÿçš„ç¨‹åºã€‚æ ¹æ–‡ä»¶ç³»ç»Ÿè¿˜åŒ…å«å¯å®‰è£…æ–‡ä»¶ç³»ç»Ÿä»¥è¿æ¥åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„çš„å®‰è£…ç‚¹ã€‚ Linux åªæœ‰ä¸€ä¸ªæ–‡ä»¶æ ‘,æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿæ˜¯ä»¥ä¸€ä¸ªæ ‘æ ¹ â€œ/â€ ä¸ºèµ·ç‚¹çš„ï¼Œæ‰€æœ‰çš„æ–‡ä»¶å’Œå¤–éƒ¨è®¾å¤‡éƒ½ä»¥æ–‡ä»¶çš„å½¢å¼æŒ‚ç»“åœ¨è¿™ä¸ªæ–‡ä»¶æ ‘ä¸Šï¼ŒåŒ…æ‹¬ç¡¬ç›˜ã€è½¯ç›˜ã€å…‰é©±ã€è°ƒåˆ¶è§£è°ƒå™¨ç­‰ï¼Œè¿™å’Œä»¥ â€œé©±åŠ¨å™¨ç›˜ç¬¦â€ ä¸ºåŸºç¡€çš„Windowsç³»ç»Ÿæ˜¯å¤§ä¸ç›¸åŒçš„ã€‚\nç¼–è¯‘åŠç”Ÿæˆï¼š æ ¹æ–‡ä»¶ç³»ç»Ÿçš„åˆ¶ä½œå¯ä»¥è‡ªå·±å»ºç«‹å„ä¸ªç³»ç»Ÿæ–‡ä»¶å¤¹æ·»åŠ éœ€è¦çš„åº“å’Œå¯åŠ¨æ–‡ä»¶ç„¶åæ‰“åŒ…æˆå¯åˆ†å‘çš„é•œåƒã€‚ ç›®å‰ä¸€èˆ¬ä½¿ç”¨ buildroot æˆ–è€… busybox æ¥åˆ¶ä½œæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œbuildroot æ¯” busybox æ›´å¼ºå¤§å¹¶ä¸”åŒ…å«äº† busybox ã€‚\nä¸‹è½½ buildroot æºç ï¼š\nâœ git clone git://git.buildroot.net/buildroot ä¸º Beaglebone é…ç½® buildrootï¼š\nâœ make beaglebone_defconfig å¦‚æœåªç¼–è¯‘æ–‡ä»¶ç³»ç»Ÿï¼Œéœ€è¦åšä¸€äº›ä¿®æ”¹ï¼š\nâœ make menuconfig å–æ¶ˆå‹¾é€‰ Kernel -- Linux Kernelï¼Œè¿™é‡Œä¸ç¼–è¯‘å†…æ ¸ï¼› å–æ¶ˆå‹¾é€‰ bootloaders -- u-bootï¼Œä¹Ÿä¸ç¼–è¯‘ u-bootï¼›\n Target options ---:  Floating point strategy (NEON)  ARM instruction set (Thumb2) Toolchain ---  Toolchain type (External toolchain)  Toolchain (Linaro ARM 2014.08)  Toolchain origin (Toolchain to be downloaded and installed) //è®© buildroot è‡ªå·±ä¸‹è½½ Target packages ---  Networking applications ---  [*] dhcpcd  [*] openssh  Text editors and viewers ---  [*] nano Filesystem images ---  ext2/3/4 variant (ext4) ---  (X) ext4 ä¿å­˜ç„¶åï¼š\nâœ make make çš„æ—¶å€™ buildroot ä¼šè”ç½‘ä¸‹è½½ä¸€äº›ç¼–è¯‘å·¥å…·æˆ–è€…ä¾èµ–åŒ…ã€‚æœ€åä¼šåœ¨ output æ–‡ä»¶å¤¹ä¸­ç”Ÿæˆç›¸åº”çš„æ–‡ä»¶ç³»ç»Ÿï¼ŒæŠŠç”Ÿæˆçš„æ–‡ä»¶ç³»ç»Ÿçƒ§å†™è¿› SD å¡ä¸­ï¼š\nâœ sudo dd if=buildroot/output/images/rootfs.ext4 of=/dev/sdc2 å€¼å¾—æ³¨æ„çš„æ˜¯ç”¨ä»¥ä¸Šå‘½ä»¤çƒ§å†™ä¹‹åå¯ä»¥çœ‹åˆ° SD å¡ä½¿ç”¨ç‡å˜æˆ 100%ï¼Œæ²¡æœ‰ç©ºé—´å†™åˆ«çš„æ–‡ä»¶è¿›å»äº†ã€‚ è¿™æ˜¯å› ä¸ºä½¿ç”¨ dd å‘½ä»¤ä¸ä»…ä»…æŠŠæ–‡ä»¶è€Œæ˜¯æŠŠæ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½çƒ§å†™åˆ° SD å¡ä¸­äº†ï¼ŒåŒ…æ‹¬ç£ç›˜ä½¿ç”¨ç‡çš„ metadata æè¿°ã€‚è™½ç„¶ SD å¡ä¸Šè¿˜æœ‰å¾ˆå¤šå‰©ä½™ç©ºé—´ï¼Œä½†æ˜¯å‰©ä½™ç©ºé—´è¿˜æ²¡æœ‰åˆå¹¶åˆ°ç‰¹å®šçš„åˆ†åŒºä¸Šï¼Œéšè—åœ¨ SD å¡åˆ†åŒºçš„æœ«å°¾ã€‚ è¿™ä¸ªæ—¶å€™ä½¿ç”¨ resize å‘½ä»¤å°±èƒ½åˆå¹¶äº†ï¼ˆåœ¨ ext2ã€ext3å’Œext4ä¸Šéƒ½èƒ½ä½¿ç”¨ï¼Œå¹¶ä¸”æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™ä¼šæç¤ºä½¿ç”¨ e2fsck æ£€æŸ¥ä¸‹æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‰æç¤ºæ“ä½œå³å¯ï¼‰ï¼š\nâœ sudo resize2fs /dev/sda99 å¦‚æœæˆ‘ä»¬åœ¨ buildroot ä¸­çš„ toolchain æŒ‡å®šå¤–éƒ¨ç¼–è¯‘å·¥å…·ä¸ºä¹‹å‰åœ¨ Ubuntu ä¸Šé¢ apt-get çš„äº¤å‰ç¼–è¯‘å™¨ï¼Œé‚£ä¹ˆç¼–è¯‘çš„æ—¶å€™åˆ™ä¼šå‡ºç°é”™è¯¯ä¿¡æ¯ï¼š\n Distribution toolchains are unsuitable for use by Buildroot, as they were configured in a way that makes them non-relocatable, and contain a lot of pre-built libraries that would conflict with the ones Buildroot wants to build.\n è¿™æ˜¯å› ä¸º Ubuntu å¾—åˆ°çš„äº¤å‰ç¼–è¯‘å™¨è¢«é…ç½®æˆä¸å¯é‡å®šä½çš„ï¼Œè€Œä¸”åŒ…å«äº†ä¸€äº›ä¸ buildroot ç›¸å†²çªçš„åº“ï¼Œå®˜æ–¹è§£é‡Šï¼š\n Distro toolchains, i.ie. toolchains coing with distributions, will almost invariably be unsuitable for use with Buildroot:\n they are mostly non-relocatable; their sysroot is tainted with a lot of extra libraries.    Especially, the toolchains coming with Ubuntu (really, all the Debian familly of distros) are configured with â€“sysroot=/ which makes them non-relocatable, and they already contain quite some libraries that conflict (in any combination of version, API or ABI) with what Buildroot wants to build (i.e. extra libraries, some not even present in Buildrootâ€¦) but also their mere preence when Buildroot does not expect them to be already built (so that a package would enable features when it should not).\n æ‰€ä»¥æˆ‘ä»¬è¦è‡ªå·±ä¸‹è½½äº¤å‰ç¼–è¯‘å·¥å…·æˆ–è€…è®© buildroot è‡ªåŠ¨ä¸‹è½½ã€‚\nå¼€å§‹å®Œæ•´å¯åŠ¨ Linux å‡†å¤‡ï¼š\n SD å¡å·²ç»åˆ†å¥½ä¸¤ä¸ªåŒºï¼ŒåŒº 1 ä¸º FTA æ ¼å¼ï¼ŒåŒº 2 ä¸º EXT4 æ ¼å¼ï¼ŒåŒº 1 å‰é¢ç•™æœ‰ 1 MB çš„ç©ºé—´ä¾› U-Boot ä½¿ç”¨ U-Boot å·²ç»ç¼–è¯‘å¥½å¹¶æŠŠ MLO å’Œ uboot.img æ–‡ä»¶çƒ§å†™åˆ° SD å¡çš„å‰ 1M èµ·å§‹ä½ç½®ï¼Œä»¥ä¾¿å¤„ç†å™¨ç”¨ RAW Mode å¯åŠ¨ U-bootï¼Œå…·ä½“è¯·çœ‹BeagleBone Black ä»é›¶åˆ°ä¸€ (1 MLOã€U-Boot)ï¼› Linux å·²ç»ç¼–è¯‘å¥½å¹¶ä¸”ç”Ÿæˆäº† zImageã€System.mapï¼› initramfs å·²ç»åˆ¶ä½œå¥½å¹¶ä¸”ç”Ÿæˆäº† initrd.imgï¼›ï¼ˆå¦‚æœæ²¡æœ‰ç‰¹æ®Šçš„å¯åŠ¨å‰è¦æ±‚æ­¤é¡¹å¯ä»¥å¿½ç•¥ï¼‰ï¼› æ–‡ä»¶ç³»ç»Ÿå·²ç»åˆ¶ä½œå¥½å¹¶ä¸”çƒ§å…¥åˆ° SD å¡çš„ ext4 åˆ†åŒºä¸­ï¼›  æ–°å»º boot ç›®å½•ï¼š\nâœ mkdir boot æ‹·è´å†…æ ¸ç¼–è¯‘å‡ºæ¥çš„ zImage å’Œ System.map è‡³ boot ç›®å½•å¹¶é‡å‘½åï¼š\nâœ cp zImage ~/boot/ âœ cp System.map ~/boot/ âœ mv ~/boot/zImage ~/boot/vmlinuz æŠŠ initrd.img å’Œ dtb æ–‡ä»¶æ‹·è´åˆ° boot æ–‡ä»¶å¤¹ï¼Œå†æŠŠæ•´ä¸ª boot æ–‡ä»¶å¤¹æ‹·è´åˆ° ext4 åˆ†åŒºçš„æ ¹ç›®å½•ã€‚ åœ¨ FTA åˆ†åŒºä¸­æ–°å»º uEnv.txt æ–‡ä»¶ï¼Œè®© U-Boot å¯åŠ¨ä¹‹åè‡ªåŠ¨è¿è¡Œç›¸åº”çš„æŒ‡ä»¤å¯åŠ¨ Linuxï¼š\n## uEnv.txt å¯ä»¥å¼•ç”¨é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Œåœ¨ include/configs/xxx.h é‡Œé¢å®šä¹‰ ## å› ä¸º SDRAM çš„åœ°å€æ˜¯ä» 0x80000000å¼€å§‹çš„ï¼Œè¿™é‡Œè®¾ç½®é•œåƒã€dtbã€initrdåŠ è½½åˆ°çš„åœ°å€åˆ†åˆ«ä¸º 0x82000000ã€0x88000000ã€0x88080000 loadaddr=0x82000000 fdtaddr=0x88000000 rdaddr=0x88080000 ## è®¾ç½® initrd_high=0xffffffff fdt_high=0xffffffff  ## è®¾ç½®å‘½ä»¤ä¸ºå…ˆæ‰“å° debug ä¿¡æ¯ï¼Œç„¶åä»ç¬¬ 0 ä¸ª MMC è®¾å¤‡çš„ç¬¬ 2 ä¸ªåˆ†åŒºé‡Œé¢çš„boot æ–‡ä»¶å¤¹ä¸­çš„ vmliuz æ–‡ä»¶åŠ è½½åˆ° loadaddr å¤„ loadximage=echo debug: [/boot/vmlinuz] ... ; load mmc 0:2 ${loadaddr} /boot/vmlinuz} ## åŒæ ·çš„åŠ è½½ dtb æ–‡ä»¶ loadxfdt=echo debug: [/boot/{fdtfile}] ... ;load mmc 0:2 ${fdtaddr} /boot/${fdtfile} ## åŠ è½½ initrd loadxrd=echo debug: [/boot/initrd.img] ... ; load mmc 0:2 ${rdaddr} /boot/initrd.img; setenv rdsize ${filesize} ## åŠ è½½ç¬¬äºŒä¸ªåˆ†åŒºçš„ uEnv.txt æ–‡ä»¶ loaduEnvtxt=load mmc 0:2 ${loadaddr} /boot/uEnv.txt ; env import -t ${loadaddr} ${filesize}; ## æ£€æŸ¥ ${dtb} å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦ä¸ä¸º 0ï¼Œå¦‚æœä¸ä¸º 0 å°±èµ‹å€¼ç»™ fdtfile check_dtb=if test -n ${dtb}; then setenv fdtfile ${dtb};fi; ## è¿è¡Œå‰é¢æŒ‡å®šçš„å‘½ä»¤ loadall=run loaduEnvtxt; run check_dtb; run loadximage; run loadxrd; run loadxfdt;  ## è®¾ç½®ä¼ é€’ç»™å†…æ ¸çš„å‚æ•°ï¼Œå…¶ä¸­ cmdline æ˜¯åœ¨ç¬¬äºŒä¸ªåˆ†åŒºä¹Ÿå°±æ˜¯æ”¾ç½® linux é•œåƒçš„åˆ†åŒºå†…çš„ boot æ–‡ä»¶å¤¹ä¸­çš„ uEnv.txt åŠ è½½çš„ mmcargs=setenv bootargs console=tty0 console=${console} ${optargs} ${cape_disable} ${cape_enable} root=/dev/mmcblk0p2 rootfstype=${mmcrootfstype} ${cmdline}  ## æ ¹æ®å‰é¢å‡ ç¯‡æ–‡ç«  U-Boot çš„é…ç½®ï¼Œå¯åŠ¨åä¼šè¿è¡Œ uenvcmd uenvcmd=run loadall; run mmcargs; echo debug: [${bootargs}] ... ; echo debug: [bootz ${loadaddr} ${rdaddr}:${rdsize} ${fdtaddr}] ... ; bootz ${loadaddr} ${rdaddr}:${rdsize} ${fdtaddr}; SD å¡ä¸­ ext4 åˆ†åŒºä¸­ boot æ–‡ä»¶å¤¹ä¸­å†åˆ›å»ºä¸€ä¸ª uEnv.txtï¼Œè¿™è¾¹çš„ uEnv.txt ä¾¿äºå‘ U-Boot ä¼ é€’ä¸€äº›å†…æ ¸å‚æ•°ä¹‹ç±»çš„ï¼Œä¸ç”¨æ¯æ¬¡æ¢äº†å†…æ ¸ä¹‹ç±»çš„éƒ½å»ä¿®æ”¹ U-Boot é‚£è¾¹çš„æ–‡ä»¶:\nuname_r=3.8.13-bone79 #uuid= #dtb= cmdline=coherent_pool=1M quiet init=/lib/systemd/systemd cape_universal=enable éƒ½è®¾ç½®å¥½äº†ä¹‹åï¼ŒæŠŠ SD å¡æ’å…¥ beaglebone ä¸­å¹¶ä¸”æŒ‰ä½ S2 é”®ä¸Šç”µå°±èƒ½ä» SD å¡ä¸­å¯åŠ¨äº†ã€‚\nå‚è€ƒï¼š  vmlinuz Definition åˆ¶ä½œ initramfs/initrd é•œåƒ System.map è§£æ Device Treeï¼šèƒŒæ™¯ä»‹ç» Linux2.6 å†…æ ¸çš„ Initrd æœºåˆ¶è§£æ æ·±å…¥ç†è§£ Linux 2.6 çš„ initramfs æ©Ÿåˆ¶ (ä¸Š) Why do I need initramfs ? How to use initramfs Initramfs Tutorial ramfs, rootfs and initramfs   ",
  "wordCount" : "1828",
  "inLanguage": "en",
  "datePublished": "2016-04-17T15:06:55Z",
  "dateModified": "2016-04-17T15:06:55Z",
  "author":{
    "@type": "Person",
    "name": "X"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jesseguox.github.io/tinyx/post/BBB-Prepare-booting/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "TinyX",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jesseguox.github.io/tinyx/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jesseguox.github.io/tinyx/" accesskey="h" title="TinyX ğŸ‘¾ (Alt + H)">TinyX ğŸ‘¾</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jesseguox.github.io/tinyx/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://jesseguox.github.io/tinyx/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://jesseguox.github.io/tinyx/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://jesseguox.github.io/tinyx/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://jesseguox.github.io/tinyx/">Home</a>&nbsp;Â»&nbsp;<a href="https://jesseguox.github.io/tinyx/post/">Posts</a></div>
    <h1 class="post-title">
      BeagleBone Black ä»é›¶åˆ°ä¸€ (3 Linux é•œåƒã€initramfsã€Device TreeåŠæ ¹æ–‡ä»¶ç³»ç»Ÿ)
    </h1>
    <div class="post-meta"><span title='2016-04-17 15:06:55 +0000 UTC'>April 17, 2016</span>&nbsp;Â·&nbsp;X

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%86%85%e6%a0%b8%e5%90%af%e5%8a%a8" aria-label="å†…æ ¸å¯åŠ¨">å†…æ ¸å¯åŠ¨</a><ul>
                        
                <li>
                    <a href="#linux-%e5%90%af%e5%8a%a8%e9%9c%80%e8%a6%81%e7%9a%84%e6%96%87%e4%bb%b6" aria-label="Linux å¯åŠ¨éœ€è¦çš„æ–‡ä»¶">Linux å¯åŠ¨éœ€è¦çš„æ–‡ä»¶</a></li></ul>
                </li>
                <li>
                    <a href="#linux-%e5%86%85%e6%a0%b8%e9%95%9c%e5%83%8f" aria-label="Linux å†…æ ¸é•œåƒ">Linux å†…æ ¸é•œåƒ</a><ul>
                        
                <li>
                    <a href="#%e7%bc%96%e8%af%91%e5%8f%8a%e7%94%9f%e6%88%90" aria-label="ç¼–è¯‘åŠç”Ÿæˆï¼š">ç¼–è¯‘åŠç”Ÿæˆï¼š</a></li></ul>
                </li>
                <li>
                    <a href="#initrdinitramfs" aria-label="initrdã€initramfs">initrdã€initramfs</a><ul>
                        
                <li>
                    <a href="#%e7%bc%96%e8%af%91%e5%8f%8a%e7%94%9f%e6%88%90-1" aria-label="ç¼–è¯‘åŠç”Ÿæˆï¼š">ç¼–è¯‘åŠç”Ÿæˆï¼š</a></li></ul>
                </li>
                <li>
                    <a href="#systemmap" aria-label="System.map">System.map</a><ul>
                        
                <li>
                    <a href="#%e7%bc%96%e8%af%91%e5%8f%8a%e7%94%9f%e6%88%90-2" aria-label="ç¼–è¯‘åŠç”Ÿæˆï¼š">ç¼–è¯‘åŠç”Ÿæˆï¼š</a></li></ul>
                </li>
                <li>
                    <a href="#device-tree-%e6%9c%ba%e5%88%b6" aria-label="Device Tree æœºåˆ¶">Device Tree æœºåˆ¶</a><ul>
                        
                <li>
                    <a href="#%e7%bc%96%e8%af%91%e5%8f%8a%e7%94%9f%e6%88%90-3" aria-label="ç¼–è¯‘åŠç”Ÿæˆï¼š">ç¼–è¯‘åŠç”Ÿæˆï¼š</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%a0%b9%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="æ ¹æ–‡ä»¶ç³»ç»Ÿ">æ ¹æ–‡ä»¶ç³»ç»Ÿ</a><ul>
                        
                <li>
                    <a href="#%e7%bc%96%e8%af%91%e5%8f%8a%e7%94%9f%e6%88%90-4" aria-label="ç¼–è¯‘åŠç”Ÿæˆï¼š">ç¼–è¯‘åŠç”Ÿæˆï¼š</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%80%e5%a7%8b%e5%ae%8c%e6%95%b4%e5%90%af%e5%8a%a8-linux" aria-label="å¼€å§‹å®Œæ•´å¯åŠ¨ Linux">å¼€å§‹å®Œæ•´å¯åŠ¨ Linux</a></li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="å‚è€ƒï¼š">å‚è€ƒï¼š</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>åŸºäº Linux 3.8</p>
<h2 id="å†…æ ¸å¯åŠ¨">å†…æ ¸å¯åŠ¨<a hidden class="anchor" aria-hidden="true" href="#å†…æ ¸å¯åŠ¨">#</a></h2>
<p><a href="http://jexbat.com/2016/BBB-Uboot/">BeagleBone Black ä»é›¶åˆ°ä¸€ (1 MLOã€U-Boot)</a> è¿™ç¯‡æ–‡ç« é‡Œè®²åˆ° U-Boot å¯åŠ¨ä¹‹åä¼šè¿è¡Œ <code>uEnv.txt</code> æ–‡ä»¶é‡Œé¢ <code>uenvcmd</code> æŒ‡ä»£çš„å‘½ä»¤ï¼Œæˆ‘ä»¬ä¹Ÿé€šå¸¸æŠŠåŠ è½½é•œåƒæ–‡ä»¶ç­‰å‘½ä»¤å†™åœ¨è¿™é‡Œã€‚</p>
<!-- raw HTML omitted -->
<p>U-Boot æœ‰å¾ˆå¤šæ–¹æ³•èƒ½å¯åŠ¨å†…æ ¸ï¼Œé€šå¸¸ä½¿ç”¨çš„æ˜¯ <code>bootm</code> æˆ–è€… <code>bootz</code> å‘½ä»¤ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>U-Boot# help bootz
</span></span><span style="display:flex;"><span>bootz - boot Linux zImage image from memory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>bootz <span style="color:#f92672">[</span>addr <span style="color:#f92672">[</span>initrd<span style="color:#f92672">[</span>:size<span style="color:#f92672">]]</span> <span style="color:#f92672">[</span>fdt<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>    - boot Linux zImage stored in memory
</span></span><span style="display:flex;"><span>        The argument <span style="color:#e6db74">&#39;initrd&#39;</span> is optional and specifies the address
</span></span><span style="display:flex;"><span>        of the initrd in memory. The optional argument <span style="color:#e6db74">&#39;:size&#39;</span> allows
</span></span><span style="display:flex;"><span>        specifying the size of RAW initrd.
</span></span><span style="display:flex;"><span>        When booting a Linux kernel which requires a flat device-tree
</span></span><span style="display:flex;"><span>        a third argument is required which is the address of the
</span></span><span style="display:flex;"><span>        device-tree blob. To boot that kernel without an initrd image,
</span></span><span style="display:flex;"><span>        use a <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#66d9ef">for</span> the second argument. If you <span style="color:#66d9ef">do</span> not pass a third
</span></span><span style="display:flex;"><span>        a bd_info struct will be passed instead
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>U-Boot# help bootm
</span></span><span style="display:flex;"><span>bootm - boot application image from memory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>bootm <span style="color:#f92672">[</span>addr <span style="color:#f92672">[</span>arg ...<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>    - boot application image stored in memory
</span></span><span style="display:flex;"><span>        passing arguments <span style="color:#e6db74">&#39;arg ...&#39;</span>; when booting a Linux kernel,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;arg&#39;</span> can be the address of an initrd image
</span></span><span style="display:flex;"><span>        When booting a Linux kernel which requires a flat device-tree
</span></span><span style="display:flex;"><span>        a third argument is required which is the address of the
</span></span><span style="display:flex;"><span>        device-tree blob. To boot that kernel without an initrd image,
</span></span><span style="display:flex;"><span>        use a <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#66d9ef">for</span> the second argument. If you <span style="color:#66d9ef">do</span> not pass a third
</span></span><span style="display:flex;"><span>        a bd_info struct will be passed instead
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>For the new multi component uImage format <span style="color:#f92672">(</span>FIT<span style="color:#f92672">)</span> addresses
</span></span><span style="display:flex;"><span>        must be extened to include component or configuration unit name:
</span></span><span style="display:flex;"><span>        addr:&lt;subimg_uname&gt; - direct component image specification
</span></span><span style="display:flex;"><span>        addr#&lt;conf_uname&gt;   - configuration specification
</span></span><span style="display:flex;"><span>        Use iminfo command to get the list of existing component
</span></span><span style="display:flex;"><span>        images and configurations.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sub-commands to <span style="color:#66d9ef">do</span> part of the bootm sequence.  The sub-commands must be
</span></span><span style="display:flex;"><span>issued in the order below <span style="color:#f92672">(</span>it<span style="color:#960050;background-color:#1e0010">&#39;</span>s ok to not issue all sub-commands<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>        start <span style="color:#f92672">[</span>addr <span style="color:#f92672">[</span>arg ...<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>        loados  - load OS image
</span></span><span style="display:flex;"><span>        ramdisk - relocate initrd, set env initrd_start/initrd_end
</span></span><span style="display:flex;"><span>        fdt     - relocate flat device tree
</span></span><span style="display:flex;"><span>        cmdline - OS specific command line processing/setup
</span></span><span style="display:flex;"><span>        bdt     - OS specific bd_t processing
</span></span><span style="display:flex;"><span>        prep    - OS specific prep before relocation or go
</span></span><span style="display:flex;"><span>        go      - start OS
</span></span></code></pre></div><p>bootz å¯åŠ¨å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ zImage ï¼Œæ”¯æŒ device-treeï¼Œå…¶ä¸­ä¸€äº›å‚æ•°ï¼š
addrï¼šå†…æ ¸åœ°å€
initrdï¼šramdisk é•œåƒåœ°å€ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šçš„ initrd éœ€è¦ä¼ é€’ä¸€ä¸ª <code>-</code> ç»™å¯åŠ¨æŒ‡ä»¤ã€‚ä»€ä¹ˆæ˜¯ ramdisk é•œåƒå‘¢ï¼Ÿæˆ‘ä»¬ä¸‹é¢ä¼šè®²åˆ°ã€‚
fdtï¼š flat device tree åœ°å€ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š fdt åœ°å€ï¼Œä¼šä¼ å…¥ä¸€ä¸ª <code>bd_info</code> ç»“æ„ä½“ã€‚ä»€ä¹ˆæ˜¯ Device Tree å‘¢ï¼Ÿæˆ‘ä»¬ä¸‹é¢ä¹Ÿä¼šè®²åˆ°ã€‚</p>
<h3 id="linux-å¯åŠ¨éœ€è¦çš„æ–‡ä»¶">Linux å¯åŠ¨éœ€è¦çš„æ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#linux-å¯åŠ¨éœ€è¦çš„æ–‡ä»¶">#</a></h3>
<p>Linux å¯åŠ¨çš„æ—¶å€™éœ€è¦æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿæ¥è¿è¡Œåˆå§‹åŒ–ç¨‹åºï¼Œå†æ€»ç»“ bootz å‘½ä»¤ï¼Œæ‰€ä»¥ U-Boot å¯åŠ¨ Linux å†…æ ¸éœ€è¦ä»¥ä¸‹æ–‡ä»¶ï¼š
å†…æ ¸é•œåƒã€initrd æ–‡ä»¶ï¼ˆramdisk é•œåƒï¼‰ã€DTBï¼ˆDevice Tree Binaryï¼‰ã€æ ¹æ–‡ä»¶ç³»ç»Ÿ
ä¸æ˜¯å¿…è¦ä½†æ˜¯ä¹Ÿæ˜¯éœ€è¦çš„æ–‡ä»¶ï¼š
System.map</p>
<h2 id="linux-å†…æ ¸é•œåƒ">Linux å†…æ ¸é•œåƒ<a hidden class="anchor" aria-hidden="true" href="#linux-å†…æ ¸é•œåƒ">#</a></h2>
<p>vm ä»£è¡¨ Virtual Memoryï¼ŒLinux æ”¯æŒè™šæ‹Ÿå†…å­˜ï¼Œå› æ­¤å¾—å vmã€‚Linux å†…æ ¸æŒ‰å¼•å¯¼ç¨‹åºçš„ä¸åŒåˆ†ä¸åŒçš„æ ¼å¼ï¼Œä¸»è¦æœ‰ï¼š</p>
<ul>
<li><strong>vmlinux</strong>		: æœ€åŸå§‹çš„å†…æ ¸é™æ€é“¾æ¥åå¯æ‰§è¡Œçš„æ–‡ä»¶æ ¼å¼ ELFï¼Œæ²¡æœ‰å‹ç¼©ï¼Œä¸å¯å¯åŠ¨çš„å†…æ ¸é•œåƒï¼Œå¯èƒ½åœ¨è°ƒè¯•é˜¶æ®µæ‰ä¼šç”¨åˆ°ã€‚</li>
<li><strong>vmlinux.bin</strong> 	: å’Œ vmlinux ç±»ä¼¼ä¸è¿‡æ˜¯å¯å¯åŠ¨çš„ RAW Binary æ ¼å¼ã€‚æ‰€æœ‰çš„æ ‡å¿—å’Œé‡å®šä½ä¿¡æ¯éƒ½è¢«ä¸¢å¼ƒï¼Œç”± vmlinux é€šè¿‡å‘½ä»¤ <code>objcopy -O binary vmlinux vmlinux.bin</code> ç”Ÿæˆã€‚</li>
<li><strong>vmlinuz</strong>		: ç»è¿‡å‹ç¼©è¿‡çš„ <code>vmlinux</code> å¯å¯åŠ¨é•œåƒã€‚å¯å¯åŠ¨è¡¨ç¤ºæœ‰èƒ½åŠ›åŠ è½½æ“ä½œç³»ç»Ÿåˆ°å†…å­˜ä¸­è¿è¡Œï¼Œvmlinuz é€šå¸¸ç”± zImage å’Œ bzImage æ‹·è´è€Œæ¥ã€‚</li>
<li><strong>zImage</strong>			: æ¯”zImage æ˜¯ ARM linux å¸¸ç”¨çš„ä¸€ç§å‹ç¼©é•œåƒæ–‡ä»¶ï¼Œå®ƒæ˜¯ç”± vmlinux åŠ ä¸Šè§£å‹ä»£ç ç» gzip å‹ç¼©è€Œæˆï¼Œé€šå¸¸æ”¾åœ¨å°å°ºå¯¸ ROM ä¸­ï¼ˆå°äº 512Kï¼‰ï¼ŒzImage è§£å‹ç¼©å†…æ ¸åˆ°ä½å®¹é‡å†…å­˜(640K)ã€‚ç”±å‘½ä»¤ <code>make zImage</code> ç”Ÿæˆã€‚</li>
<li><strong>bzImage</strong>		: bz è¡¨ç¤º big zImage,å…¶æ ¼å¼ä¸ zImage ç±»ä¼¼ï¼Œä½†é‡‡ç”¨äº†ä¸åŒçš„å‹ç¼©ç®—æ³•ã€‚bzImage éœ€è¦è§£å‹ç¼©å†…æ ¸åˆ°é«˜å®¹é‡å†…å­˜(1Mä»¥ä¸Š)ã€‚ç”±å‘½ä»¤ <code>make bzImage</code> ç”Ÿæˆã€‚</li>
<li><strong>uImage</strong>			: uImage æ˜¯ uboot ä¸“ç”¨çš„é•œåƒæ–‡ä»¶ï¼Œå®ƒæ˜¯åœ¨ zImage ä¹‹å‰åŠ ä¸Šä¸€ä¸ªé•¿åº¦ä¸º 0x40 çš„å¤´ä¿¡æ¯(tag)ï¼Œåœ¨å¤´ä¿¡æ¯å†…è¯´æ˜äº†è¯¥é•œåƒæ–‡ä»¶çš„ç±»å‹ã€åŠ è½½ ä½ç½®ã€ç”Ÿæˆæ—¶é—´ã€å¤§å°ç­‰ä¿¡æ¯ã€‚å…¶ 0x40 ä¹‹åä¸ zImage æ²¡åŒºåˆ«ã€‚</li>
</ul>
<h3 id="ç¼–è¯‘åŠç”Ÿæˆ">ç¼–è¯‘åŠç”Ÿæˆï¼š<a hidden class="anchor" aria-hidden="true" href="#ç¼–è¯‘åŠç”Ÿæˆ">#</a></h3>
<p>BeagleBone çš„å†…æ ¸é•œåƒæ‰˜ç®¡åœ¨ <a href="https://github.com/beagleboard/linux">Github</a>
ç¼–è¯‘ä¹‹å‰å¯èƒ½éœ€è¦å®‰è£…çš„åº“</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ sudo apt-get install lzop
</span></span><span style="display:flex;"><span>âœ sudo apt-get install libncurses5-dev libncursesw5-dev
</span></span></code></pre></div><p>æºç é‡Œé¢å·²ç»åŒ…å«äº† BeagleBone çš„é…ç½®æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ git clone git://github.com/beagleboard/linux.git
</span></span><span style="display:flex;"><span>âœ cd linux
</span></span><span style="display:flex;"><span>âœ git checkout 3.8
</span></span><span style="display:flex;"><span>âœ make distclean
</span></span><span style="display:flex;"><span>âœ make ARCH<span style="color:#f92672">=</span>arm CROSS_COMPILE<span style="color:#f92672">=</span>arm-linux-gnueabi- bb.org_defconfig 
</span></span><span style="display:flex;"><span>âœ make ARCH<span style="color:#f92672">=</span>arm CROSS_COMPILE<span style="color:#f92672">=</span>arm-linux-gnueabihf- zImage dtbs -j4
</span></span></code></pre></div><p>ç¼–è¯‘å®Œæˆåä¼šåœ¨ <code>arch/arm/boot</code> ç›®å½•ä¸‹é¢ç”Ÿæˆ zImage é•œåƒå’Œ dtbs æ–‡ä»¶ã€‚
æˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>make  ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-  menuconfig</code> æˆ–è€… <code>make   ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-  xconfig</code> æ¥è‡ªå·±é…ç½®éœ€è¦ç¼–è¯‘çš„å†…å®¹ã€‚
å¦‚æœä½¿ç”¨ <code>make xconfig</code> åˆ™éœ€è¦å®‰è£… qt å’Œä¸€äº›ä¾èµ–ï¼Œå¦‚æœä½¿ç”¨è™šæ‹Ÿæœºä¸èƒ½ä½¿ç”¨ ssh çš„æ–¹å¼è¿œç¨‹ç¼–è¯‘ï¼Œéœ€è¦æ‰“å¼€è™šæ‹Ÿçš„å›¾å½¢ç•Œé¢è¿›è¡Œç¼–è¯‘ã€‚
xconfig çš„ä¸€äº›ä¾èµ–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ sudo apt-get update
</span></span><span style="display:flex;"><span>âœ sudo apt-get install libqt4-dev pkg-config
</span></span><span style="display:flex;"><span>âœ sudo apt-get install g++
</span></span></code></pre></div><h2 id="initrdinitramfs">initrdã€initramfs<a hidden class="anchor" aria-hidden="true" href="#initrdinitramfs">#</a></h2>
<p>Linux kernel åœ¨è‡ªèº«åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œéœ€è¦èƒ½å¤Ÿæ‰¾åˆ°å¹¶è¿è¡Œç¬¬ä¸€ä¸ªç”¨æˆ·ç¨‹åºï¼ˆè¿™ä¸ªç¨‹åºé€šå¸¸å«åš â€œinitâ€ ç¨‹åºï¼‰ã€‚ç”¨æˆ·ç¨‹åºå­˜åœ¨äºæ–‡ä»¶ç³»ç»Ÿä¹‹ä¸­ï¼Œå› æ­¤ï¼Œå†…æ ¸å¿…é¡»æ‰¾åˆ°å¹¶æŒ‚è½½ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ‰å¯ä»¥æˆåŠŸå®Œæˆç³»ç»Ÿçš„å¼•å¯¼è¿‡ç¨‹ã€‚æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆrootfsï¼‰ æ‰€åœ¨çš„å‚¨å­˜è£…ç½®å¾ˆå¯èƒ½æéš¾å¯»æ‰¾ï¼Œæ¯”æ–¹è¯´ SCSI è£…ç½®å°±éœ€è¦å¤æ‚ä¸”è€—æ—¶çš„ç¨‹åºï¼Œè‹¥ç”¨ RAID ç³»ç»Ÿæ›´æ˜¯éœ€è¦çœ‹é…ç½®æƒ…å†µè€Œå®šï¼ŒåŒæ ·çš„é—®é¢˜ä¹Ÿå‘ç”Ÿåœ¨ USB storage ä¸Šï¼Œå› ä¸º kernel å¾—èŠ±ä¸Šæ›´é•¿çš„ç­‰å¾…ä¸é…ç½®æ—¶é—´ï¼Œåˆæˆ–è€…éœ€è¦è¿œç«¯æŒ‚è½½ rootfsï¼Œä¸ä»…å¾—å¤„ç†ç½‘è·¯è£…ç½®çš„é—®é¢˜ï¼Œç”šè‡³è¿˜å¾—è€ƒè™‘ç›¸å…³çš„ä¼ºæœå™¨è®¤è¯ã€é€šè®¯å¾€è¿”æ—¶é—´ç­‰è®®é¢˜ã€‚ä¸ºè§£å†³æ­¤é—®é¢˜ï¼ŒLinux kernel æå‡ºäº†ä¸€ä¸ª RAM disk çš„è§£å†³æ–¹æ¡ˆï¼ŒæŠŠä¸€äº›å¯åŠ¨æ‰€å¿…é¡»çš„ç”¨æˆ·ç¨‹åºå’Œé©±åŠ¨æ¨¡å—æ”¾åœ¨ RAM disk ä¸­ï¼Œè¿™ä¸ª RAM disk çœ‹ä¸Šå»å’Œæ™®é€šçš„ disk ä¸€æ ·ï¼Œæœ‰æ–‡ä»¶ç³»ç»Ÿï¼Œæœ‰ cacheï¼Œå†…æ ¸å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæŠŠ RAM disk æŒ‚è½½èµ·æ¥ï¼Œç­‰åˆ° init ç¨‹åºå’Œä¸€äº›å¿…è¦æ¨¡å—è¿è¡Œèµ·æ¥ä¹‹åï¼Œå†åˆ‡åˆ°çœŸæ­£çš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸­ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæœ‰äº† initrdï¼ˆinit ram diskï¼‰ æˆ‘ä»¬å¯åœ¨æ”¾ç½®æŸäº›ç‰¹åˆ«çš„ç¨‹å¼ï¼Œä¸€æ¥ä½œä¸ºæŒ‚è½½ rootfs ä½œå‡†å¤‡ï¼Œæ¯”æ–¹è¯´ç¡¬ä½“åˆå§‹åŒ–ã€è§£å¯†ã€è§£å‹ç¼©ç­‰ç­‰ï¼ŒäºŒæ¥æç¤ºä½¿ç”¨è€…æˆ–ç³»ç»Ÿç®¡ç†å‘˜ç›®å‰çš„çŠ¶æ€ï¼Œè¿™å¯¹äºæ¶ˆè´¹æ€§ç”µå­äº§å“æ¥è¯´ï¼Œæœ‰å¾ˆå¤§çš„æ„ä¹‰ã€‚
æ•´ä½“æ¥è¯´ï¼Œå¦‚æœèƒ½å¢åŠ å¼€æœºçš„å¼¹æ€§ï¼ˆæ¯”æ–¹è¯´é…åˆç®€å•çš„shell script å³â€‹â€‹å¯è¾¾æˆUSB/SCSI åˆå§‹åŒ–åŠ¨ä½œï¼Œè‹¥é€è¿‡ kernel code å®åšï¼Œææ€•ä¸Šç™¾åƒè¡Œæ˜¯å…ä¸æ‰çš„ï¼‰ï¼Œåˆèƒ½é€‚åº¦é™ä½ kernel image æœ¬èº«çš„è®¾è®¡å¤æ‚åº¦ä¸ç©ºé—´ä½¿ç”¨é‡ï¼Œé‡‡å– initrd æ˜¯å¾ˆä¸é”™çš„æ–¹å¼ï¼Œæ‰€ä»¥å‡ ä¹å„å¤§Linux distribution éƒ½æœ‰æä¾› initrdï¼Œä»¥è§£å†³åœ¨ä¸åŒç¡¬ä½“ã€ä¸åŒè£…ç½®ä¸Šå¼€æœºçš„æŠ€æœ¯è®®é¢˜ã€‚
å¦‚æœä»”ç»†è€ƒè™‘ä¸€ä¸‹ï¼Œinitrd è™½ç„¶è§£å†³äº†é—®é¢˜ä½†å¹¶ä¸å®Œç¾ã€‚ æ¯”å¦‚ï¼Œdisk æœ‰ cache æœºåˆ¶ï¼Œå¯¹äº RAM disk æ¥è¯´ï¼Œè¿™ä¸ª cache æœºåˆ¶å°±æ˜¾å¾—å¾ˆå¤šä½™ä¸”æµªè´¹ç©ºé—´ï¼›disk éœ€è¦æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ ext2 ç­‰ï¼‰å¿…é¡»è¢«ç¼–è¯‘è¿› kernel è€Œä¸èƒ½ä½œä¸ºæ¨¡å—æ¥ä½¿ç”¨ã€‚
Linux 2.6 kernel æå‡ºäº†ä¸€ç§æ–°çš„å®ç°æœºåˆ¶ï¼Œå³ initramfsã€‚é¡¾åæ€ä¹‰ï¼Œinitramfs åªæ˜¯ä¸€ç§ RAM filesystem è€Œä¸æ˜¯ diskã€‚initramfs å®é™…æ˜¯ä¸€ä¸ª cpio å½’æ¡£ï¼Œå¯åŠ¨æ‰€éœ€çš„ç”¨æˆ·ç¨‹åºå’Œé©±åŠ¨æ¨¡å—è¢«å½’æ¡£æˆä¸€ä¸ªæ–‡ä»¶ã€‚å› æ­¤ï¼Œä¸éœ€è¦ cacheï¼Œä¹Ÿä¸éœ€è¦æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<p>å¼•ç”¨ï¼š<a href="http://www.linuxfromscratch.org/blfs/view/cvs/postlfs/initramfs.html">å…³äº initramfs </a></p>
<blockquote>
<p>The only purpose of an initramfs is to mount the root filesystem. The initramfs is a complete set of directories that you would find on a normal root filesystem. It is bundled into a single cpio archive and compressed with one of several compression algorithms.
initramfs çš„å”¯ä¸€ç”¨é€”å°±æ˜¯æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚initramfs å°±æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ç³»ç»Ÿç›®å½•çš„å®Œæ•´çš„é›†åˆã€‚å®ƒç”¨å‡ ä¸ªå‹ç¼©ç®—æ³•æ‰“åŒ…æˆ cpio æ ¼å¼ã€‚
There are only four primary reasons to have an initramfs in the LFS environment: loading the rootfs from a network, loading it from an LVM logical volume, having an encrypted rootfs where a password is required, or for the convenience of specifying the rootfs as a LABEL or UUID. Anything else usually means that the kernel was not configured properly.
åœ¨ LFS (Linux From Scratch) ä¸­ initramfs çš„å­˜åœ¨ä¸»è¦æœ‰å››ä¸ªä¸»è¦çš„åŸå› ï¼šä»ç½‘ç»œåŠ è½½æ ¹æ–‡ä»¶ç³»ç»Ÿã€ä» LMM é€»è¾‘å·åŠ è½½çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€åŠ å¯†è¿‡çš„éœ€è¦å¯†ç çš„æ ¹æ–‡ä»¶ç³»ç»Ÿæˆ–è€…æ–¹ä¾¿çš„æŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿä¸º LABLE æˆ–è€… UUIDã€‚è¿˜æœ‰åˆ«çš„é€šå¸¸æ„å‘³ç€å†…æ ¸é…ç½®ä¸æ­£ç¡®ã€‚
For most distributions, kernel modules are the biggest reason to have an initramfs. In a general distribution, there are many unknowns such as file system types and disk layouts. In a way, this is the opposite of LFS where the system capabilities and layout are known and a custom kernel is normally built. In this situation, an initramfs is rarely needed.
å¯¹äºå¤§å¤šæ•°åˆ†å‘ç‰ˆæœ¬æ¥è¯´ï¼Œéœ€è¦ initramfs æœ€å¤§çš„åŸå› æ˜¯å†…æ ¸æ¨¡å—ã€‚åœ¨ä¸€èˆ¬çš„åˆ†å‘ä¸­ï¼Œæœ‰å¾ˆå¤šæœªçŸ¥çš„æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜åˆ†å¸ƒï¼Œåœ¨æŸç§ç¨‹åº¦ä¸‹ï¼Œè¿™æ˜¯åœ¨ç³»ç»Ÿèƒ½åŠ›å’Œå¸ƒå±€æœªçŸ¥çš„æƒ…å†µã€‚ å¦‚æœè¯´ç³»ç»Ÿèƒ½åŠ›å’Œå¸ƒå±€å·²çŸ¥ï¼Œå†…æ ¸å·²ç»å»ºç«‹çš„æƒ…å†µä¸‹å¾ˆå°‘éœ€è¦ initramfsã€‚</p>
</blockquote>
<p>ä¸Šé¢æåˆ°çš„ RAM DISK ä¸º image-initrdï¼ŒRAM filesystem ä¸º cpio-initrdï¼Œå†…æ ¸å¯åŠ¨çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­æ˜¯å¦ä¸º cpio æ ¼å¼ï¼Œå¦‚æœä¸æ˜¯çš„è¯ä¼šå½“ä½œ image-initrd å¤„ç†ã€‚</p>
<p>cpio-initrd å’Œ image-initrd å¤„ç†æµç¨‹å¯ä»¥å‚è€ƒï¼š<a href="https://www.ibm.com/developerworks/cn/linux/l-k26initrd/">Linux2.6 å†…æ ¸çš„ Initrd æœºåˆ¶è§£æ</a>ã€‚</p>
<h3 id="ç¼–è¯‘åŠç”Ÿæˆ-1">ç¼–è¯‘åŠç”Ÿæˆï¼š<a hidden class="anchor" aria-hidden="true" href="#ç¼–è¯‘åŠç”Ÿæˆ-1">#</a></h3>
<p>Linux 2.6 ä»¥æ¥éƒ½æ˜¯é»˜è®¤ä½¿ç”¨ initramfsï¼ˆ&ldquo;General setup&rdquo; çš„å­é …ç›® &ldquo;Initial RAM filesystem and RAM disk (initramfs/initrd) suppot&rdquo; æ˜¯é»˜è®¤å‹¾é€‰çš„ï¼‰ ï¼Œåªæ˜¯ç¼–è¯‘çš„è¾“å‡ºå¾ˆå¤šè¿˜æ²¿è¢­ä¼ ç»Ÿä½¿ç”¨ initrd çš„åå­—ã€‚ç¼–è¯‘çš„æ—¶å€™ä¼šç”Ÿæˆ <code> usr/initramfs_data.cpio</code> æ–‡ä»¶ï¼Œå†…æ ¸ç¼–è¯‘çš„æ—¶å€™ä¼šæŠŠè¿™ä¸ªæ–‡ä»¶ç¼–è¯‘è¿›å†…æ ¸ã€‚å¦‚æœé…ç½®é€‰é¡¹é‡Œé¢ &ldquo;Initramfs source file&rdquo; ä¸ºç©ºï¼ˆä¸æŒ‡å®š <code>CONFIG_INITRAMFS_SOURCE</code>ï¼‰ï¼Œä¼šé»˜è®¤ç¼–è¯‘å‡ºä¸€ä¸ª<strong>ç©ºçš„</strong> initramfs åŒ…ï¼ˆæ²¡æœ‰ init æ–‡ä»¶ï¼‰ã€‚
è¿™æ ·ä¸€æ¥ Linux å†…æ ¸ç¼–è¯‘çš„æ—¶å€™å¦‚æœæŒ‰é»˜è®¤æ–¹å¼ç¼–è¯‘ï¼ˆå‹¾é€‰ &ldquo;initial RAM filesystem and RAM disk (initramfs/initrd) suppot&rdquo;ï¼‰ åˆ™æœ‰å››ç§æ–¹æ³•ç”Ÿæˆ initramfs æ–‡ä»¶ï¼š
<strong>1. ä¸æŒ‡å®š <code>CONFIG_INITRAMFS_SOURCE</code> åˆ™ä¼šç¼–è¯‘å‡ºä¸€ä¸ªç©ºçš„ initramfs</strong>
<strong>2. ä¸º <code>CONFIG_INITRAMFS_SOURCE</code> æŒ‡å®šä¸€ä¸ªç°æœ‰çš„ initramfs æ–‡ä»¶</strong>
å¦‚æœä½ æœ‰ä¸€ä¸ªç°æœ‰çš„  <code>initramfs_data.cpio.gz</code> æ–‡ä»¶ï¼Œå¯ä»¥æŒ‡å®šç»™ <code>CONFIG_INITRAMFS_SOURCE</code> ï¼Œå†…æ ¸ç¼–è¯‘æ—¶ä¼šè‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç±»å‹ç„¶åé“¾æ¥åˆ°å†…æ ¸é•œåƒä¸­å»ã€‚
<strong>3. ä¸º <code>CONFIG_INITRAMFS_SOURCE</code> æŒ‡å®šä¸€ä¸ªç°æœ‰çš„æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•</strong>
å¦‚æœä¸º <code>CONFIG_INITRAMFS_SOURCE</code> æŒ‡å®šä¸€ä¸ªç›®å½•ï¼Œç¼–è¯‘çš„æ—¶å€™ä¼šè‡ªåŠ¨æŠŠæ­¤ç›®å½•æ‰“åŒ…æˆ cpio æ–‡ä»¶ï¼Œä½†æ˜¯ä¸æ˜¯ç”¨çš„æ ‡å‡†çš„ cpio å‘½ä»¤æ‰“åŒ…ï¼Œå†…æ ¸ç¼–è¯‘æ—¶ä¼šåœ¨æŒ‡å®šçš„ç›®å½•ç”Ÿæˆä¸€ä¸ªæè¿°ç›®å½•ç»“æ„çš„æ–‡æœ¬æ–‡ä»¶ <code>gen_initramfs_list.sh</code>ï¼Œç„¶åç»™ <code>gen_init_cpio</code> ç¨‹åºï¼ˆåœ¨ <code>usr</code> ç›®å½•ä¸‹ï¼‰è°ƒç”¨ï¼Œå°±ä¼šç”Ÿæˆ cpio åŒ…ã€‚
<strong>4. ä½¿ç”¨ <code>initramfs_list</code> é…ç½®æ–‡ä»¶é…ç½®</strong>
è¿™å°±æ˜¯åˆšåˆšç¬¬ä¸‰ç§æ–¹æ³•è®²çš„é…ç½®æ–‡ä»¶ <code>gen_initramfs_list.sh</code>ï¼Œä¸è¿‡æˆ‘ä»¬è¿™é‡Œæ˜¯æ‰‹åŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶è€Œä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆã€‚æ‰‹åŠ¨åˆ›å»ºåæ”¾å…¥ä¸€ä¸ªç›®å½•ä¸­ï¼Œç„¶åæŒ‡å®š <code>CONFIG_INITRAMFS_SOURCE</code> ä¸ºé‚£ä¸ªç›®å½•ç¼–è¯‘çš„æ—¶å€™å°±å¯ä»¥ç”Ÿæˆç›¸åº”çš„ cpio åŒ…ã€‚
ä¾‹å­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>file /init usr/hello <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>dir /dev <span style="color:#ae81ff">755</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>è¿™ä¸ªå†…å®¹è¡¨ç¤ºæŠŠ <code>usr/hello</code> æŒ‡å®šä¸ºæ–‡ä»¶ç³»ç»Ÿä¸­çš„ <code>init æ–‡ä»¶</code>ï¼Œæƒé™ä¸º 500ï¼Œuid å’Œ gid éƒ½ä¸º0ï¼Œå¹¶ä¸”åˆ›å»º <code>/dev</code> æ–‡ä»¶å¤¹ï¼Œæƒé™ä¸º 755ï¼Œuid å’Œ gid éƒ½ä¸º 0ã€‚
è¯¦ç»†ä½¿ç”¨æ–¹æ³•è¯·çœ‹ï¼š<a href="http://landley.net/writing/rootfs-howto.html">Tech Tip: How to use initramfs.</a></p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯æˆ‘ä»¬æŒ‰ç…§è¿™ä¸ªæ–¹æ³•åˆ¶ä½œå‡ºæ¥çš„å†…æ ¸é•œåƒå®é™…ä¸Šæ¯”åŸæ¥çš„å¤§äº†è®¸å¤šï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯å°† initramfs æ ¹æ–‡ä»¶ç³»ç»Ÿç›´æ¥åˆå¹¶åˆ°å†…æ ¸é•œåƒé‡Œè¾¹äº†ã€‚è¿™æ ·ï¼Œå¯åŠ¨å†…æ ¸æ—¶çš„å‚æ•°å°±ä¸éœ€è¦æ·»åŠ  initrd=â€¦â€¦ æ¥æŒ‡å®š initramfs çš„ä½ç½®äº†ï¼ˆæˆ–è€…é…ç½®å†…æ ¸çš„æ—¶å€™ç›´æ¥ä¸å‹¾é€‰ &ldquo;Initial RAM filesystem and RAM disk (initramfs/initrd) suppot&rdquo;ï¼Œä½†æ˜¯ä¸ºäº†å¯æ‰©å±•æ€§ä¸€èˆ¬é»˜è®¤å‹¾é€‰ï¼‰ã€‚
å¯åŠ¨å‘½ä»¤ä¸ºï¼š</p>
<pre tabindex="0"><code>bootz ${loadaddr} - ${fdtaddr};
</code></pre><p>å½“ç„¶å¦‚æœæƒ³æŒ‡å®šå¤–éƒ¨çš„ initramfs æ–‡ä»¶æ¥å¯åŠ¨ Linuxï¼Œé¦–å…ˆç›´æ¥æŒ‡å®š <code>CONFIG_INITRAMFS_SOURCE</code> ä¸ºç©ºï¼Œè¿™æ ·å°±ä¼šé“¾æ¥ä¸€ä¸ªç©ºçš„ initramfs ï¼ˆä¸€ç™¾å¤šå­—èŠ‚ï¼‰è¿›å†…æ ¸ï¼Œç„¶åæŒ‡å®šå¤–éƒ¨ initramfs çš„ä½ç½®æ¥å¯åŠ¨ã€‚
å‘½ä»¤ä¸ºï¼š</p>
<pre tabindex="0"><code>bootz ${loadaddr} ${rdaddr}:${rdsize}  ${fdtaddr};
</code></pre><p>æ‰‹åŠ¨ç”Ÿæˆ initramfs æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ mkdir sub   
</span></span><span style="display:flex;"><span>âœ cp hello sub/init
</span></span><span style="display:flex;"><span>âœ cd sub
</span></span><span style="display:flex;"><span>âœ find . | cpio -o -H newc | gzip &gt; ../initramfs_data.cpio.gz
</span></span><span style="display:flex;"><span>âœ cd ..
</span></span><span style="display:flex;"><span>âœ rm -rf sub
</span></span></code></pre></div><h2 id="systemmap">System.map<a hidden class="anchor" aria-hidden="true" href="#systemmap">#</a></h2>
<p>System.map æ˜¯ä¸€ä¸ªç‰¹å®šå†…æ ¸çš„å†…æ ¸ç¬¦å·è¡¨ã€‚å®ƒæ˜¯ä½ å½“å‰è¿è¡Œçš„å†…æ ¸çš„ç¬¦å·é“¾æ¥ã€‚Linux å†…æ ¸æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„ä»£ç å—ï¼Œæœ‰è®¸è®¸å¤šå¤šçš„å…¨å±€ç¬¦å·ã€‚å†…æ ¸å¹¶ä¸ä½¿ç”¨ç¬¦å·åã€‚å®ƒæ˜¯é€šè¿‡å˜é‡æˆ–å‡½æ•°çš„åœ°å€(æŒ‡é’ˆ)æ¥ä½¿ç”¨å˜é‡æˆ–å‡½æ•°çš„ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ size_t BytesReadï¼Œå†…æ ¸æ›´å–œæ¬¢ä½¿ç”¨(ä¾‹å¦‚) c0343f20 æ¥å¼•ç”¨è¿™ä¸ªå˜é‡ã€‚
å½“ä½ ç¼–è¯‘ä¸€ä¸ªæ–°å†…æ ¸æ—¶ï¼Œå„ä¸ªç¬¦å·åçš„åœ°å€è¦å‘ç”Ÿå˜åŒ–ï¼Œä½ çš„è€çš„ System.map å…·æœ‰çš„æ˜¯é”™è¯¯çš„ç¬¦å·ä¿¡æ¯ã€‚æ¯æ¬¡å†…æ ¸ç¼–è¯‘æ—¶äº§ç”Ÿä¸€ä¸ªæ–°çš„ System.mapï¼Œä½ åº”å½“ç”¨æ–°çš„System.map æ¥å–ä»£è€çš„ System.mapã€‚
è™½ç„¶å†…æ ¸æœ¬èº«å¹¶ä¸çœŸæ­£ä½¿ç”¨ System.mapï¼Œä½†å…¶å®ƒç¨‹åºæ¯”å¦‚ klogdï¼Œ lsof å’Œ ps ç­‰è½¯ä»¶éœ€è¦ä¸€ä¸ªæ­£ç¡®çš„ System.mapã€‚å¦‚æœä½ ä½¿ç”¨é”™è¯¯çš„æˆ–æ²¡æœ‰ System.mapï¼Œklogd çš„è¾“å‡ºå°†æ˜¯ä¸å¯é çš„ï¼Œè¿™å¯¹äºæ’é™¤ç¨‹åºæ•…éšœä¼šå¸¦æ¥å›°éš¾ã€‚æ²¡æœ‰ System.mapï¼Œä½ å¯èƒ½ä¼šé¢ä¸´ä¸€äº›ä»¤äººçƒ¦æ¼çš„æç¤ºä¿¡æ¯ã€‚
å¦å¤–å°‘æ•°é©±åŠ¨éœ€è¦ System.map æ¥è§£æç¬¦å·ï¼Œæ²¡æœ‰ä¸ºä½ å½“å‰è¿è¡Œçš„ç‰¹å®šå†…æ ¸åˆ›å»ºçš„System.map å®ƒä»¬å°±ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚
Linux çš„å†…æ ¸æ—¥å¿—å®ˆæŠ¤è¿›ç¨‹ klogd ä¸ºäº†æ‰§è¡Œåç§°-åœ°å€è§£æï¼Œklogd éœ€è¦ä½¿ç”¨System.mapã€‚System.map åº”å½“æ”¾åœ¨ä½¿ç”¨å®ƒçš„è½¯ä»¶èƒ½å¤Ÿæ‰¾åˆ°å®ƒçš„åœ°æ–¹ã€‚æ‰§è¡Œï¼šman klogd å¯çŸ¥ï¼Œå¦‚æœæ²¡æœ‰å°† System.map ä½œä¸ºä¸€ä¸ªå˜é‡çš„ä½ç½®ç»™ klogdï¼Œé‚£ä¹ˆå®ƒå°†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºï¼Œåœ¨ä¸‰ä¸ªåœ°æ–¹æŸ¥æ‰¾ System.mapï¼š
<code>/boot/System.map</code>
<code>/System.map</code>
<code>/usr/src/linux/System.map</code>
System.map ä¹Ÿæœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œklogd èƒ½å¤Ÿæ™ºèƒ½åœ°æŸ¥æ‰¾æ­£ç¡®çš„æ˜ è±¡ï¼ˆmapï¼‰æ–‡ä»¶ã€‚</p>
<h3 id="ç¼–è¯‘åŠç”Ÿæˆ-2">ç¼–è¯‘åŠç”Ÿæˆï¼š<a hidden class="anchor" aria-hidden="true" href="#ç¼–è¯‘åŠç”Ÿæˆ-2">#</a></h3>
<p>System.map æ–‡ä»¶åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™ä¼šè‡ªåŠ¨ç”Ÿæˆåœ¨æºç æ ¹ç›®å½•ä¸‹ï¼Œæ¯æ¬¡é‡æ–°ç¼–è¯‘å†…æ ¸éƒ½è¦æ›¿æ¢æ‰ç›¸åº”çš„ System.mapã€‚</p>
<h2 id="device-tree-æœºåˆ¶">Device Tree æœºåˆ¶<a hidden class="anchor" aria-hidden="true" href="#device-tree-æœºåˆ¶">#</a></h2>
<p>Kernel 3.x ç‰ˆæœ¬ä¹‹åå¼€å§‹æ”¯æŒ Device Tree æœºåˆ¶ã€‚
åœ¨æ—©æœŸçš„ARM Linux Kernelä¸­ï¼Œæ¿çº§ç»†èŠ‚ï¼ˆBSPï¼‰ä½¿ç”¨ä»£ç å½¢å¼ï¼Œå­˜æ”¾åœ¨ <code>arch/arm/</code> ç›®å½•ã€‚åå­—é€šå¸¸ä¸ºï¼šplat-xxxx æˆ–è€… mach-xxxxï¼Œç›¸å½“å¤šæ•°çš„ä»£ç åªæ˜¯åœ¨æè¿°æ¿çº§ç»†èŠ‚ï¼Œè€Œè¿™äº›æ¿çº§ç»†èŠ‚å¯¹äºå†…æ ¸æ¥è®²ï¼Œä¸è¿‡æ˜¯åƒåœ¾ã€‚æ¿çº§ä»£ç åªå¯¹ç›¸åº”å¼€å‘æ¿æœ‰ç”¨ï¼Œæ¯æ¬¡å‡çº§ Kernel éƒ½éœ€è¦å¯¹æ¿çº§ä»£ç è¿›è¡Œå‡çº§å’Œæµ‹è¯•ï¼ŒARM å¯¹åº”çš„å¼€å‘æ¿åˆç§ç±»ç¹å¤šæ‰€ä»¥è¿™äº›ä»£ç è¶Šæ¥è¶Šè‡ƒè‚¿åºå¤§ã€‚
å¼•å…¥äº† Device Tree ä¹‹åï¼Œæ”¹å˜äº†åŸæ¥ç”¨ç¡¬ç¼–ç çš„æ–¹å¼æŠŠæ¿çº§ä»£ç åµŒå…¥åœ¨å†…æ ¸é‡Œé¢ï¼Œæ”¹ç”¨é€šè¿‡ Bootloader ä¼ é€’ DB æ–‡ä»¶çš„æ–¹å¼æŠŠç¡¬ä»¶ä¿¡æ¯ä¼ é€’ç»™ Kernelï¼Œå®ç°äº†å†…æ ¸å’Œæ¿çº§ä»£ç çš„ä½è€¦åˆï¼Œå‡å°‘å†…æ ¸ä»£ç çš„è‡ƒè‚¿é™ä½ç»´æŠ¤äººå‘˜çš„æˆæœ¬ã€‚
Uboot çš„ä¸»çº¿ä»£ç ä» v1.1.3 å¼€å§‹å°±æ”¯æŒ DT äº†ï¼Œå…¶å¯¹ARMçš„æ”¯æŒå’Œ Kernel å¯¹ Device Tree çš„æ”¯æŒæ˜¯åŒæœŸå®Œæˆçš„ï¼Œåœ¨ Uboot ä¸­éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥  <code> #define CONFIG_OF_LIBFDT</code> é…ç½®é¡¹å³å¯ï¼Œå½“æˆ‘ä»¬å°† DTB æ–‡ä»¶åœ¨ Uboot é‡ŒåŠ è½½åˆ°å†…å­˜ä¸­åï¼Œé€šè¿‡ <code>fdt addr 0xnnnnnnnn</code> å‘½ä»¤æ¥è®¾ç½® DTB æ–‡ä»¶å¯¹åº”åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ <code>fdt resize</code>ã€<code>fdt print</code> ç­‰å‘½ä»¤å¯¹ DTB æ–‡ä»¶è¿›è¡Œæ“ä½œäº†ã€‚å¯¹äº ARMï¼Œä½¿ç”¨ <code>bootz ${loadaddr} ${rdaddr}:${rdsize}  ${fdtaddr}</code> å‘½ä»¤æ¥å¯åŠ¨ Kernelã€‚
æ›´å¤šèƒŒæ™¯ä»‹ç»ï¼š<a href="http://www.wowotech.net/device_model/why-dt.html">Device Tree èƒŒæ™¯ä»‹ç»</a></p>
<h3 id="ç¼–è¯‘åŠç”Ÿæˆ-3">ç¼–è¯‘åŠç”Ÿæˆï¼š<a hidden class="anchor" aria-hidden="true" href="#ç¼–è¯‘åŠç”Ÿæˆ-3">#</a></h3>
<p>DTSï¼šDevice Tree Source  ä½äºç›®å½•   <code>linux/arch/arm/boot/dts</code>
DTCï¼šDevice Tree Compiler ä½äºç›®å½• <code>linux/scripts/dtc/dtc</code>
DTBï¼šDevice Tree Binary  ç”Ÿæˆåœ¨ <code>linux/arch/arm/boot/dts</code>
DTB æ˜¯ç”± DTS é€šè¿‡ DTC ç¼–è¯‘è€Œæˆã€‚
åœ¨æ„å»ºå†…æ ¸çš„æ—¶å€™å¯ä»¥ä½¿ç”¨  <code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- dtbs</code> ç”Ÿæˆã€‚
Device Tree Binary åœ¨ç¼–è¯‘ linux å†…æ ¸çš„æ—¶å€™è‡ªåŠ¨æ ¹æ® <code>arch/arm/boot/dts/Makefile</code> æŒ‡å®šçš„æ–¹å¼ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡ dtc æ‰‹åŠ¨ç¼–è¯‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ ./scripts/dtc/dtc -I dts -O dtb -o ./devicetree.dtb ./beaglebone.dts
</span></span></code></pre></div><p><strong>DTS ç»„æˆå’Œç»“æ„ä¸“é—¨å†™ä¸€ç¯‡æ–‡ç« æ¥è®²ã€‚</strong></p>
<h2 id="æ ¹æ–‡ä»¶ç³»ç»Ÿ">æ ¹æ–‡ä»¶ç³»ç»Ÿ<a hidden class="anchor" aria-hidden="true" href="#æ ¹æ–‡ä»¶ç³»ç»Ÿ">#</a></h2>
<p>æ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯å†…æ ¸æŒ‚è½½çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæ ¹æ–‡ä»¶ç³»ç»Ÿä¸ºåˆ†å±‚æ–‡ä»¶æ ‘çš„é¡¶ç‚¹ã€‚å®ƒåŒ…å«å¯¹äºç³»ç»Ÿæ“ä½œå¾ˆå…³é”®çš„æ–‡ä»¶å’Œç›®å½•ï¼ŒåŒ…æ‹¬è®¾å¤‡ç›®å½•å’Œç”¨äºå¼•å¯¼ç³»ç»Ÿçš„ç¨‹åºã€‚æ ¹æ–‡ä»¶ç³»ç»Ÿè¿˜åŒ…å«å¯å®‰è£…æ–‡ä»¶ç³»ç»Ÿä»¥è¿æ¥åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„çš„å®‰è£…ç‚¹ã€‚
Linux åªæœ‰ä¸€ä¸ªæ–‡ä»¶æ ‘,æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿæ˜¯ä»¥ä¸€ä¸ªæ ‘æ ¹ &ldquo;/&rdquo; ä¸ºèµ·ç‚¹çš„ï¼Œæ‰€æœ‰çš„æ–‡ä»¶å’Œå¤–éƒ¨è®¾å¤‡éƒ½ä»¥æ–‡ä»¶çš„å½¢å¼æŒ‚ç»“åœ¨è¿™ä¸ªæ–‡ä»¶æ ‘ä¸Šï¼ŒåŒ…æ‹¬ç¡¬ç›˜ã€è½¯ç›˜ã€å…‰é©±ã€è°ƒåˆ¶è§£è°ƒå™¨ç­‰ï¼Œè¿™å’Œä»¥ &ldquo;é©±åŠ¨å™¨ç›˜ç¬¦â€ ä¸ºåŸºç¡€çš„Windowsç³»ç»Ÿæ˜¯å¤§ä¸ç›¸åŒçš„ã€‚</p>
<h3 id="ç¼–è¯‘åŠç”Ÿæˆ-4">ç¼–è¯‘åŠç”Ÿæˆï¼š<a hidden class="anchor" aria-hidden="true" href="#ç¼–è¯‘åŠç”Ÿæˆ-4">#</a></h3>
<p>æ ¹æ–‡ä»¶ç³»ç»Ÿçš„åˆ¶ä½œå¯ä»¥è‡ªå·±å»ºç«‹å„ä¸ªç³»ç»Ÿæ–‡ä»¶å¤¹æ·»åŠ éœ€è¦çš„åº“å’Œå¯åŠ¨æ–‡ä»¶ç„¶åæ‰“åŒ…æˆå¯åˆ†å‘çš„é•œåƒã€‚
ç›®å‰ä¸€èˆ¬ä½¿ç”¨ buildroot æˆ–è€… busybox æ¥åˆ¶ä½œæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œbuildroot æ¯” busybox æ›´å¼ºå¤§å¹¶ä¸”åŒ…å«äº† busybox ã€‚</p>
<p>ä¸‹è½½ buildroot æºç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ git clone git://git.buildroot.net/buildroot
</span></span></code></pre></div><p>ä¸º Beaglebone é…ç½® buildrootï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ make beaglebone_defconfig
</span></span></code></pre></div><p>å¦‚æœåªç¼–è¯‘æ–‡ä»¶ç³»ç»Ÿï¼Œéœ€è¦åšä¸€äº›ä¿®æ”¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ make menuconfig
</span></span></code></pre></div><p>å–æ¶ˆå‹¾é€‰ <code>Kernel --&gt; Linux Kernel</code>ï¼Œè¿™é‡Œä¸ç¼–è¯‘å†…æ ¸ï¼›
å–æ¶ˆå‹¾é€‰ <code>bootloaders --&gt; u-boot</code>ï¼Œä¹Ÿä¸ç¼–è¯‘ u-bootï¼›</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target options ---&gt;:
</span></span><span style="display:flex;"><span>    Floating point strategy <span style="color:#f92672">(</span>NEON<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    ARM instruction set <span style="color:#f92672">(</span>Thumb2<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Toolchain ---&gt;
</span></span><span style="display:flex;"><span>    Toolchain type <span style="color:#f92672">(</span>External toolchain<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Toolchain <span style="color:#f92672">(</span>Linaro ARM 2014.08<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Toolchain origin <span style="color:#f92672">(</span>Toolchain to be downloaded and installed<span style="color:#f92672">)</span> //è®© buildroot è‡ªå·±ä¸‹è½½
</span></span><span style="display:flex;"><span>Target packages ---&gt;
</span></span><span style="display:flex;"><span>    Networking applications ---&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> dhcpcd
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> openssh
</span></span><span style="display:flex;"><span>    Text editors and viewers ---&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> nano
</span></span><span style="display:flex;"><span>Filesystem images ---&gt;
</span></span><span style="display:flex;"><span>    ext2/3/4 variant <span style="color:#f92672">(</span>ext4<span style="color:#f92672">)</span> ---&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>X<span style="color:#f92672">)</span> ext4
</span></span></code></pre></div><p>ä¿å­˜ç„¶åï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ make
</span></span></code></pre></div><p>make çš„æ—¶å€™ buildroot ä¼šè”ç½‘ä¸‹è½½ä¸€äº›ç¼–è¯‘å·¥å…·æˆ–è€…ä¾èµ–åŒ…ã€‚æœ€åä¼šåœ¨ output æ–‡ä»¶å¤¹ä¸­ç”Ÿæˆç›¸åº”çš„æ–‡ä»¶ç³»ç»Ÿï¼ŒæŠŠç”Ÿæˆçš„æ–‡ä»¶ç³»ç»Ÿçƒ§å†™è¿› SD å¡ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ sudo dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>buildroot/output/images/rootfs.ext4 of<span style="color:#f92672">=</span>/dev/sdc2
</span></span></code></pre></div><p><strong>å€¼å¾—æ³¨æ„çš„æ˜¯ç”¨ä»¥ä¸Šå‘½ä»¤çƒ§å†™ä¹‹åå¯ä»¥çœ‹åˆ° SD å¡ä½¿ç”¨ç‡å˜æˆ 100%ï¼Œæ²¡æœ‰ç©ºé—´å†™åˆ«çš„æ–‡ä»¶è¿›å»äº†ã€‚</strong>
è¿™æ˜¯å› ä¸ºä½¿ç”¨ dd å‘½ä»¤ä¸ä»…ä»…æŠŠæ–‡ä»¶è€Œæ˜¯æŠŠæ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½çƒ§å†™åˆ° SD å¡ä¸­äº†ï¼ŒåŒ…æ‹¬ç£ç›˜ä½¿ç”¨ç‡çš„ metadata æè¿°ã€‚è™½ç„¶ SD å¡ä¸Šè¿˜æœ‰å¾ˆå¤šå‰©ä½™ç©ºé—´ï¼Œä½†æ˜¯å‰©ä½™ç©ºé—´è¿˜æ²¡æœ‰åˆå¹¶åˆ°ç‰¹å®šçš„åˆ†åŒºä¸Šï¼Œéšè—åœ¨ SD å¡åˆ†åŒºçš„æœ«å°¾ã€‚
è¿™ä¸ªæ—¶å€™ä½¿ç”¨ resize å‘½ä»¤å°±èƒ½åˆå¹¶äº†ï¼ˆåœ¨ ext2ã€ext3å’Œext4ä¸Šéƒ½èƒ½ä½¿ç”¨ï¼Œå¹¶ä¸”æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™ä¼šæç¤ºä½¿ç”¨ <code>e2fsck</code> æ£€æŸ¥ä¸‹æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‰æç¤ºæ“ä½œå³å¯ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ sudo resize2fs /dev/sda99
</span></span></code></pre></div><p>å¦‚æœæˆ‘ä»¬åœ¨ buildroot ä¸­çš„ toolchain æŒ‡å®šå¤–éƒ¨ç¼–è¯‘å·¥å…·ä¸ºä¹‹å‰åœ¨ Ubuntu ä¸Šé¢ apt-get çš„äº¤å‰ç¼–è¯‘å™¨ï¼Œé‚£ä¹ˆç¼–è¯‘çš„æ—¶å€™åˆ™ä¼šå‡ºç°é”™è¯¯ä¿¡æ¯ï¼š</p>
<blockquote>
<p>Distribution toolchains are unsuitable for use by Buildroot,
as they were configured in a way that makes them non-relocatable,
and contain a lot of pre-built libraries that would conflict with
the ones Buildroot wants to build.</p>
</blockquote>
<p>è¿™æ˜¯å› ä¸º Ubuntu å¾—åˆ°çš„äº¤å‰ç¼–è¯‘å™¨è¢«é…ç½®æˆä¸å¯é‡å®šä½çš„ï¼Œè€Œä¸”åŒ…å«äº†ä¸€äº›ä¸ buildroot ç›¸å†²çªçš„åº“ï¼Œå®˜æ–¹è§£é‡Šï¼š</p>
<blockquote>
<p>Distro toolchains, i.ie. toolchains coing with distributions, will
almost invariably be unsuitable for use with Buildroot:</p>
<ul>
<li>they are mostly non-relocatable;</li>
<li>their sysroot is tainted with a lot of extra libraries.</li>
</ul>
</blockquote>
<blockquote>
<p>Especially, the toolchains coming with Ubuntu (really, all the Debian
familly of distros) are configured with &ndash;sysroot=/ which makes them
non-relocatable, and they already contain quite some libraries that
conflict (in any combination of version, API or ABI) with what Buildroot
wants to build (i.e. extra libraries, some not even present in
Buildroot&hellip;) but also their mere preence when Buildroot does not expect
them to be already built (so that a package would enable features when
it should not).</p>
</blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬è¦è‡ªå·±<a href="https://www.linaro.org/downloads/">ä¸‹è½½</a>äº¤å‰ç¼–è¯‘å·¥å…·æˆ–è€…è®© buildroot è‡ªåŠ¨ä¸‹è½½ã€‚</p>
<h2 id="å¼€å§‹å®Œæ•´å¯åŠ¨-linux">å¼€å§‹å®Œæ•´å¯åŠ¨ Linux<a hidden class="anchor" aria-hidden="true" href="#å¼€å§‹å®Œæ•´å¯åŠ¨-linux">#</a></h2>
<p>å‡†å¤‡ï¼š</p>
<ul>
<li>SD å¡å·²ç»åˆ†å¥½ä¸¤ä¸ªåŒºï¼ŒåŒº 1 ä¸º FTA æ ¼å¼ï¼ŒåŒº 2 ä¸º EXT4 æ ¼å¼ï¼ŒåŒº 1 å‰é¢ç•™æœ‰ 1 MB çš„ç©ºé—´ä¾› U-Boot ä½¿ç”¨</li>
<li>U-Boot å·²ç»ç¼–è¯‘å¥½å¹¶æŠŠ MLO å’Œ uboot.img æ–‡ä»¶çƒ§å†™åˆ° SD å¡çš„å‰ 1M èµ·å§‹ä½ç½®ï¼Œä»¥ä¾¿å¤„ç†å™¨ç”¨ RAW Mode å¯åŠ¨ U-bootï¼Œå…·ä½“è¯·çœ‹<a href="http://jexbat.com/2016/BBB-Uboot/">BeagleBone Black ä»é›¶åˆ°ä¸€ (1 MLOã€U-Boot)</a>ï¼›</li>
<li>Linux å·²ç»ç¼–è¯‘å¥½å¹¶ä¸”ç”Ÿæˆäº† zImageã€System.mapï¼›</li>
<li>initramfs å·²ç»åˆ¶ä½œå¥½å¹¶ä¸”ç”Ÿæˆäº† initrd.imgï¼›ï¼ˆå¦‚æœæ²¡æœ‰ç‰¹æ®Šçš„å¯åŠ¨å‰è¦æ±‚æ­¤é¡¹å¯ä»¥å¿½ç•¥ï¼‰ï¼›</li>
<li>æ–‡ä»¶ç³»ç»Ÿå·²ç»åˆ¶ä½œå¥½å¹¶ä¸”çƒ§å…¥åˆ° SD å¡çš„ ext4 åˆ†åŒºä¸­ï¼›</li>
</ul>
<p>æ–°å»º boot ç›®å½•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ mkdir boot
</span></span></code></pre></div><p>æ‹·è´å†…æ ¸ç¼–è¯‘å‡ºæ¥çš„ zImage å’Œ System.map è‡³ boot ç›®å½•å¹¶é‡å‘½åï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ cp zImage  ~/boot/
</span></span><span style="display:flex;"><span>âœ cp System.map ~/boot/
</span></span><span style="display:flex;"><span>âœ mv ~/boot/zImage ~/boot/vmlinuz
</span></span></code></pre></div><p>æŠŠ initrd.img å’Œ dtb æ–‡ä»¶æ‹·è´åˆ° boot æ–‡ä»¶å¤¹ï¼Œå†æŠŠæ•´ä¸ª boot æ–‡ä»¶å¤¹æ‹·è´åˆ° ext4 åˆ†åŒºçš„æ ¹ç›®å½•ã€‚
åœ¨ FTA åˆ†åŒºä¸­æ–°å»º uEnv.txt æ–‡ä»¶ï¼Œè®© U-Boot å¯åŠ¨ä¹‹åè‡ªåŠ¨è¿è¡Œç›¸åº”çš„æŒ‡ä»¤å¯åŠ¨ Linuxï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>## uEnv.txt å¯ä»¥å¼•ç”¨é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Œåœ¨ include/configs/xxx.h é‡Œé¢å®šä¹‰
</span></span><span style="display:flex;"><span>## å› ä¸º SDRAM çš„åœ°å€æ˜¯ä» 0x80000000å¼€å§‹çš„ï¼Œè¿™é‡Œè®¾ç½®é•œåƒã€dtbã€initrdåŠ è½½åˆ°çš„åœ°å€åˆ†åˆ«ä¸º 0x82000000ã€0x88000000ã€0x88080000
</span></span><span style="display:flex;"><span>loadaddr=0x82000000
</span></span><span style="display:flex;"><span>fdtaddr=0x88000000
</span></span><span style="display:flex;"><span>rdaddr=0x88080000
</span></span><span style="display:flex;"><span>## è®¾ç½®
</span></span><span style="display:flex;"><span>initrd_high=0xffffffff
</span></span><span style="display:flex;"><span>fdt_high=0xffffffff
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>## è®¾ç½®å‘½ä»¤ä¸ºå…ˆæ‰“å° debug ä¿¡æ¯ï¼Œç„¶åä»ç¬¬ 0 ä¸ª MMC è®¾å¤‡çš„ç¬¬ 2 ä¸ªåˆ†åŒºé‡Œé¢çš„boot æ–‡ä»¶å¤¹ä¸­çš„ vmliuz æ–‡ä»¶åŠ è½½åˆ° loadaddr å¤„
</span></span><span style="display:flex;"><span>loadximage=echo debug: [/boot/vmlinuz] ... ; load mmc 0:2 ${loadaddr} /boot/vmlinuz}
</span></span><span style="display:flex;"><span>## åŒæ ·çš„åŠ è½½ dtb æ–‡ä»¶
</span></span><span style="display:flex;"><span>loadxfdt=echo debug: [/boot/{fdtfile}] ... ;load mmc 0:2 ${fdtaddr} /boot/${fdtfile}
</span></span><span style="display:flex;"><span>## åŠ è½½ initrd
</span></span><span style="display:flex;"><span>loadxrd=echo debug: [/boot/initrd.img] ... ; load mmc 0:2 ${rdaddr} /boot/initrd.img; setenv rdsize ${filesize}
</span></span><span style="display:flex;"><span>## åŠ è½½ç¬¬äºŒä¸ªåˆ†åŒºçš„ uEnv.txt æ–‡ä»¶
</span></span><span style="display:flex;"><span>loaduEnvtxt=load mmc 0:2 ${loadaddr} /boot/uEnv.txt ; env import -t ${loadaddr} ${filesize};
</span></span><span style="display:flex;"><span>## æ£€æŸ¥ ${dtb} å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦ä¸ä¸º 0ï¼Œå¦‚æœä¸ä¸º 0 å°±èµ‹å€¼ç»™ fdtfile
</span></span><span style="display:flex;"><span>check_dtb=if test -n ${dtb}; then setenv fdtfile ${dtb};fi;
</span></span><span style="display:flex;"><span>## è¿è¡Œå‰é¢æŒ‡å®šçš„å‘½ä»¤
</span></span><span style="display:flex;"><span>loadall=run loaduEnvtxt; run check_dtb; run loadximage; run loadxrd; run loadxfdt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>## è®¾ç½®ä¼ é€’ç»™å†…æ ¸çš„å‚æ•°ï¼Œå…¶ä¸­ cmdline æ˜¯åœ¨ç¬¬äºŒä¸ªåˆ†åŒºä¹Ÿå°±æ˜¯æ”¾ç½® linux é•œåƒçš„åˆ†åŒºå†…çš„ boot æ–‡ä»¶å¤¹ä¸­çš„ uEnv.txt åŠ è½½çš„
</span></span><span style="display:flex;"><span>mmcargs=setenv bootargs console=tty0 console=${console} ${optargs} ${cape_disable} ${cape_enable} root=/dev/mmcblk0p2 rootfstype=${mmcrootfstype} ${cmdline}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>##  æ ¹æ®å‰é¢å‡ ç¯‡æ–‡ç«  U-Boot çš„é…ç½®ï¼Œå¯åŠ¨åä¼šè¿è¡Œ uenvcmd
</span></span><span style="display:flex;"><span>uenvcmd=run loadall; run mmcargs; echo debug: [${bootargs}] ... ; echo debug: [bootz ${loadaddr} ${rdaddr}:${rdsize} ${fdtaddr}] ... ; bootz ${loadaddr} ${rdaddr}:${rdsize} ${fdtaddr};
</span></span></code></pre></div><p>SD å¡ä¸­ ext4 åˆ†åŒºä¸­ boot æ–‡ä»¶å¤¹ä¸­å†åˆ›å»ºä¸€ä¸ª uEnv.txtï¼Œè¿™è¾¹çš„ uEnv.txt ä¾¿äºå‘ U-Boot ä¼ é€’ä¸€äº›å†…æ ¸å‚æ•°ä¹‹ç±»çš„ï¼Œä¸ç”¨æ¯æ¬¡æ¢äº†å†…æ ¸ä¹‹ç±»çš„éƒ½å»ä¿®æ”¹ U-Boot é‚£è¾¹çš„æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>uname_r=3.8.13-bone79
</span></span><span style="display:flex;"><span>#uuid=
</span></span><span style="display:flex;"><span>#dtb=
</span></span><span style="display:flex;"><span>cmdline=coherent_pool=1M quiet init=/lib/systemd/systemd cape_universal=enable
</span></span></code></pre></div><p>éƒ½è®¾ç½®å¥½äº†ä¹‹åï¼ŒæŠŠ SD å¡æ’å…¥ beaglebone ä¸­å¹¶ä¸”æŒ‰ä½ S2 é”®ä¸Šç”µå°±èƒ½ä» SD å¡ä¸­å¯åŠ¨äº†ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒï¼š<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h2>
<ul>
<li><a href="http://www.linfo.org/vmlinuz.html">vmlinuz Definition</a></li>
<li><a href="http://www.cnblogs.com/wwang/archive/2010/10/27/1862222.html">åˆ¶ä½œ initramfs/initrd é•œåƒ</a></li>
<li><a href="http://blog.csdn.net/tommy_wxie/article/details/8039695">System.map è§£æ</a></li>
<li><a href="http://www.wowotech.net/device_model/why-dt.html">Device Treeï¼šèƒŒæ™¯ä»‹ç»</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-k26initrd/">Linux2.6 å†…æ ¸çš„ Initrd æœºåˆ¶è§£æ</a></li>
<li><a href="http://blog.linux.org.tw/~jserv/archives/001954.html">æ·±å…¥ç†è§£ Linux 2.6 çš„ initramfs æ©Ÿåˆ¶ (ä¸Š)</a></li>
<li><a href="http://unix.stackexchange.com/questions/122100/why-do-i-need-initramfs">Why do I need initramfs ?</a></li>
<li><a href="http://landley.net/writing/rootfs-howto.html">How to use initramfs</a></li>
<li><a href="http://nairobi-embedded.org/initramfs_tutorial.html">Initramfs Tutorial</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/filesystems/ramfs-rootfs-initramfs.txt">ramfs, rootfs and initramfs</a></li>
</ul>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://jesseguox.github.io/tinyx/tags/BeagleBone/">BeagleBone</a></li>
      <li><a href="https://jesseguox.github.io/tinyx/tags/Linux/">Linux</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://jesseguox.github.io/tinyx/post/NAS-Shadowsocks/">
    <span class="title">Â« Prev Page</span>
    <br>
    <span>Synology DS216Play å®‰è£… ShadowSocks</span>
  </a>
  <a class="next" href="https://jesseguox.github.io/tinyx/post/BeagleBone-Image/">
    <span class="title">Next Page Â»</span>
    <br>
    <span>è§£æ BeagleBone Black å®˜æ–¹é•œåƒ</span>
  </a>
</nav>

  </footer><div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: [''],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://jesseguox.github.io/tinyx/">TinyX</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
